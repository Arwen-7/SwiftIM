// IMProtocol.proto
// 自定义 IM 协议定义（使用 Protocol Buffers）
// 编译命令：protoc --swift_out=. IMProtocol.proto

syntax = "proto3";

package im.protocol;

// ============================================
// 协议包格式（不使用 Protobuf，使用原始二进制）
// ============================================
//
// 包头（固定 16 字节）:
// +--------+--------+--------+--------+--------+--------+--------+--------+
// | Magic  | Ver    | CmdID  | Seq    | BodyLen          | Reserved        |
// | 2 byte | 1 byte | 2 byte | 4 byte | 4 byte           | 3 byte          |
// +--------+--------+--------+--------+--------+--------+--------+--------+
//
// Magic:    协议魔数 0xEF89（用于识别合法包）
// Ver:      协议版本（当前为 1）
// CmdID:    命令类型（见 CommandType）
// Seq:      序列号（用于请求-响应匹配、去重、排序）
// BodyLen:  包体长度（字节数）
// Reserved: 保留字段（未来扩展）
//
// 包体（变长）:
// 使用 Protobuf 序列化的具体消息内容
//
// ============================================

// 命令类型
enum CommandType {
    CMD_UNKNOWN = 0;
    
    // 连接相关（1-99）
    CMD_CONNECT_REQ = 1;         // 连接请求
    CMD_CONNECT_RSP = 2;         // 连接响应
    CMD_DISCONNECT_REQ = 3;      // 断开请求
    CMD_DISCONNECT_RSP = 4;      // 断开响应
    CMD_HEARTBEAT_REQ = 5;       // 心跳请求
    CMD_HEARTBEAT_RSP = 6;       // 心跳响应
    
    // 认证相关（100-199）
    CMD_AUTH_REQ = 100;          // 认证请求
    CMD_AUTH_RSP = 101;          // 认证响应
    CMD_REAUTH_REQ = 102;        // 重新认证请求
    CMD_REAUTH_RSP = 103;        // 重新认证响应
    CMD_KICK_OUT = 104;          // 踢出通知
    
    // 消息相关（200-299）
    CMD_SEND_MSG_REQ = 200;      // 发送消息请求
    CMD_SEND_MSG_RSP = 201;      // 发送消息响应
    CMD_PUSH_MSG = 202;          // 推送消息（服务器 → 客户端）
    CMD_MSG_ACK = 203;           // 消息 ACK
    CMD_BATCH_MSG = 204;         // 批量消息
    CMD_REVOKE_MSG_REQ = 205;    // 撤回消息请求
    CMD_REVOKE_MSG_RSP = 206;    // 撤回消息响应
    CMD_REVOKE_MSG_PUSH = 207;   // 撤回消息推送
    
    // 同步相关（300-399）
    CMD_BATCH_SYNC_REQ = 300;         // 批量同步请求（一次性同步所有会话）
    CMD_BATCH_SYNC_RSP = 301;         // 批量同步响应
    CMD_SYNC_FINISHED = 302;          // 同步完成通知
    CMD_SYNC_RANGE_REQ = 303;         // 范围同步请求（补拉丢失消息）
    CMD_SYNC_RANGE_RSP = 304;         // 范围同步响应
    
    // 在线状态（400-499）
    CMD_ONLINE_STATUS_REQ = 400; // 查询在线状态请求
    CMD_ONLINE_STATUS_RSP = 401; // 在线状态响应
    CMD_STATUS_CHANGE_PUSH = 402;// 状态变化推送
    
    // 已读回执（500-599）
    CMD_READ_RECEIPT_REQ = 500;  // 已读回执请求
    CMD_READ_RECEIPT_RSP = 501;  // 已读回执响应
    CMD_READ_RECEIPT_PUSH = 502; // 已读回执推送
    
    // 输入状态（600-699）
    CMD_TYPING_STATUS_REQ = 600; // 输入状态请求
    CMD_TYPING_STATUS_PUSH = 601;// 输入状态推送
}

// 错误码
enum ErrorCode {
    ERR_SUCCESS = 0;             // 成功
    ERR_UNKNOWN = 1;             // 未知错误
    ERR_INVALID_PARAM = 2;       // 参数错误
    ERR_AUTH_FAILED = 100;       // 认证失败
    ERR_TOKEN_EXPIRED = 101;     // Token 过期
    ERR_PERMISSION_DENIED = 102; // 权限不足
    ERR_USER_NOT_EXIST = 103;    // 用户不存在
    ERR_MESSAGE_TOO_LARGE = 200; // 消息过大
    ERR_SEND_TOO_FAST = 201;     // 发送过快
    ERR_CONVERSATION_NOT_EXIST = 202; // 会话不存在
}

// ============================================
// 连接相关消息
// ============================================

// 连接请求
message ConnectRequest {
    string client_id = 1;        // 客户端 ID
    string platform = 2;         // 平台（iOS/Android/Web）
    string app_version = 3;      // App 版本
    string sdk_version = 4;      // SDK 版本
    string device_info = 5;      // 设备信息
    map<string, string> extra = 10; // 扩展字段
}

// 连接响应
message ConnectResponse {
    ErrorCode error_code = 1;
    string error_msg = 2;
    int64 server_time = 3;       // 服务器时间（毫秒）
    string session_id = 4;       // 会话 ID
}

// 心跳请求
message HeartbeatRequest {
    int64 client_time = 1;       // 客户端时间（毫秒）
}

// 心跳响应
message HeartbeatResponse {
    int64 server_time = 1;       // 服务器时间（毫秒）
}

// ============================================
// 认证相关消息
// ============================================

// 认证请求
message AuthRequest {
    string user_id = 1;
    string token = 2;
    string platform = 3;
}

// 认证响应
message AuthResponse {
    ErrorCode error_code = 1;
    string error_msg = 2;
    int64 max_seq = 3;           // 当前最大序列号（用于增量同步）
}

// 踢出通知
message KickOutNotification {
    int32 reason = 1;            // 踢出原因（1: 其他设备登录，2: 账号异常等）
    string message = 2;
}

// ============================================
// 消息相关
// ============================================

// 通用消息信息（各场景复用）
message MessageInfo {
    string server_msg_id = 1;    // ✅ 服务器消息 ID（发送时为空，由服务端生成）
    string client_msg_id = 2;    // 客户端消息 ID
    string conversation_id = 3;  // 会话 ID
    string sender_id = 4;        // 发送者 ID
    string receiver_id = 5;      // 接收者 ID（单聊）
    string group_id = 6;         // 群组 ID（群聊）
    int32 message_type = 7;      // 消息类型
    bytes content = 8;           // 消息内容（JSON 字节）
    int64 send_time = 9;         // 发送时间
    int64 server_time = 10;      // 服务器时间
    int64 seq = 11;              // 消息序列号（发送时为0，由服务端生成）
    int32 status = 12;           // 消息状态（同步时使用）
    bool is_read = 13;           // 是否已读（同步时使用）
    int64 create_time = 14;      // 创建时间（客户端创建消息的时间）
    string extra = 15;           // 扩展字段（JSON 字符串）
    repeated string read_by = 16;  // 已读者 ID 列表（群聊）
    int64 read_time = 17;        // 读取时间（单聊）
    bool is_deleted = 18;        // 是否已删除
    bool is_revoked = 19;        // 是否已撤回
    string revoked_by = 20;      // 撤回者 ID
    int64 revoked_time = 21;     // 撤回时间
    string attached_info = 22;   // 附加信息
    int32 conversation_type = 23; // 会话类型（1=单聊，2=群聊，3=聊天室，4=系统消息）
}

// 发送消息请求
message SendMessageRequest {
    MessageInfo message = 1;     // ✅ 复用通用消息结构
}

// 发送消息响应
message SendMessageResponse {
    ErrorCode error_code = 1;
    string error_msg = 2;
    string server_msg_id = 3;    // ✅ 服务器消息 ID
    string client_msg_id = 4;    // 客户端消息 ID（用于匹配本地消息）
    int64 seq = 5;               // 消息序列号
    int64 server_time = 6;       // 服务器时间
}

// 推送消息
message PushMessage {
    MessageInfo message = 1;     // ✅ 复用通用消息结构
}

// 消息 ACK
message MessageAck {
    string server_msg_id = 1;  // ✅ 服务器消息 ID
    int64 seq = 2;
}

// 批量消息
message BatchMessages {
    repeated PushMessage messages = 1;
}

// 撤回消息请求
message RevokeMessageRequest {
    string server_msg_id = 1;  // ✅ 服务器消息 ID
    string conversation_id = 2;
}

// 撤回消息响应
message RevokeMessageResponse {
    ErrorCode error_code = 1;
    string error_msg = 2;
}

// 撤回消息推送
message RevokeMessagePush {
    string server_msg_id = 1;  // ✅ 服务器消息 ID
    string conversation_id = 2;
    string revoked_by = 3;
    int64 revoked_time = 4;
}

// ============================================
// 同步相关（批量同步）
// ============================================

// 会话同步状态（客户端本地状态）
message ConversationSyncState {
    string conversation_id = 1;  // 会话ID
    int64 last_seq = 2;          // 本地最大 seq
}

// 批量同步请求（一次性同步所有会话）
message BatchSyncRequest {
    repeated ConversationSyncState conversation_states = 1;  // 客户端的会话同步状态（可为空，表示首次全量同步）
    int32 max_count_per_conversation = 2;  // 每个会话最多拉取的消息数（默认100，最大500）
}

// 会话消息结果
message ConversationMessages {
    string conversation_id = 1;  // 会话ID
    repeated MessageInfo messages = 2;  // 消息列表
    int64 max_seq = 3;           // 服务端该会话的最大 seq
    int64 synced_seq = 4;        // 本次同步到的 seq（可能小于 max_seq，因为有 max_count 限制）
    bool has_more = 5;           // 是否还有更多消息未同步
}

// 批量同步响应
message BatchSyncResponse {
    ErrorCode error_code = 1;
    string error_msg = 2;
    repeated ConversationMessages conversation_messages = 3;  // 所有会话的消息
    int64 server_time = 4;       // 服务器时间
    int32 total_message_count = 5;  // 本次同步的总消息数
}

// ============================================
// 范围同步（用于补拉丢失的消息）
// ============================================

// 范围同步请求
message SyncRangeRequest {
    string request_id = 1;       // 请求唯一标识（由客户端生成，用于响应匹配）
    string conversation_id = 2;  // 会话ID（必填）
    int64 start_seq = 3;         // 起始 seq（包含）
    int64 end_seq = 4;           // 结束 seq（包含）
    int32 count = 5;             // 单次拉取数量限制（默认100，最大500）
}

// 范围同步响应
message SyncRangeResponse {
    ErrorCode error_code = 1;
    string error_msg = 2;
    string request_id = 3;           // 对应请求的 request_id
    string conversation_id = 4;      // 会话ID
    repeated MessageInfo messages = 5;  // 消息列表
    int64 start_seq = 6;             // 实际返回的起始 seq
    int64 end_seq = 7;               // 实际返回的结束 seq
    bool has_more = 8;               // 是否还有更多消息（如果请求范围过大，需要分批拉取）
}

// ============================================
// 已读回执
// ============================================

// 已读回执请求
message ReadReceiptRequest {
    repeated string server_msg_ids = 1;  // ✅ 服务器消息 ID 列表
    string conversation_id = 2;
}

// 已读回执响应
message ReadReceiptResponse {
    ErrorCode error_code = 1;
    string error_msg = 2;
}

// 已读回执推送
message ReadReceiptPush {
    repeated string server_msg_ids = 1;  // ✅ 服务器消息 ID 列表
    string conversation_id = 2;
    string user_id = 3;
    int64 read_time = 4;
}

// ============================================
// 输入状态
// ============================================

// 输入状态请求
message TypingStatusRequest {
    string conversation_id = 1;
    int32 status = 2;            // 0: 停止输入，1: 正在输入
}

// 输入状态推送
message TypingStatusPush {
    string conversation_id = 1;
    string user_id = 2;
    int32 status = 3;
}

// ============================================
// WebSocket 专用消息封装
// ============================================
//
// WebSocket 传输使用此通用消息格式（不使用 IMPacket header）
// WebSocket 自带消息边界和校验，无需额外的 length 和 CRC
//
message WebSocketMessage {
    CommandType command = 1;     // 命令类型
    uint32 sequence = 2;         // 序列号
    bytes body = 3;              // 消息体（具体消息的 Protobuf 序列化）
    int64 timestamp = 4;         // 时间戳（毫秒）
}

