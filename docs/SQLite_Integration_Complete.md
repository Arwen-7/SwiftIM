### SQLite é›†æˆåˆ°ä¸šåŠ¡å±‚ - å®Œæˆæ€»ç»“

## ğŸ‰ é›†æˆæ¦‚è§ˆ

**å®Œæˆæ—¶é—´**: 2025-10-25  
**é›†æˆæ–¹å¼**: æ•°æ®åº“åè®® + å·¥å‚æ¨¡å¼  
**å‘åå…¼å®¹**: âœ… æ”¯æŒ  
**é»˜è®¤æ•°æ®åº“**: SQLite + WAL

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. åˆ›å»ºæ•°æ®åº“åè®® âœ¨
**æ–‡ä»¶**: `IMDatabaseProtocol.swift`ï¼ˆ250+ è¡Œï¼‰

#### åŠŸèƒ½
- âœ… å®šä¹‰ç»Ÿä¸€çš„æ•°æ®åº“æ¥å£
- âœ… æ”¯æŒå¤šç§æ•°æ®åº“å®ç°ï¼ˆRealm / SQLiteï¼‰
- âœ… åŒ…å«æ‰€æœ‰ CRUD æ“ä½œæ–¹æ³•
- âœ… æ”¯æŒæ¶ˆæ¯ã€ä¼šè¯ã€ç”¨æˆ·ã€ç¾¤ç»„ã€å¥½å‹æ“ä½œ

#### æ ¸å¿ƒè®¾è®¡
```swift
/// æ•°æ®åº“ç±»å‹
public enum IMDatabaseType {
    case realm      // Realm æ•°æ®åº“ï¼ˆå…¼å®¹æ¨¡å¼ï¼‰
    case sqlite     // SQLite + WAL æ•°æ®åº“ï¼ˆæ¨èï¼‰
}

/// æ•°æ®åº“é…ç½®
public struct IMDatabaseConfig {
    public var type: IMDatabaseType  // æ•°æ®åº“ç±»å‹
    // ... å…¶ä»–é…ç½®
}

/// æ•°æ®åº“åè®®
public protocol IMDatabaseProtocol: AnyObject {
    // æ‰€æœ‰ CRUD æ“ä½œæ–¹æ³•
}
```

---

### 2. åˆ›å»ºæ•°æ®åº“å·¥å‚ âœ¨
**æ–‡ä»¶**: `IMDatabaseFactory.swift`

#### åŠŸèƒ½
- âœ… æ ¹æ®é…ç½®åˆ›å»ºç›¸åº”çš„æ•°æ®åº“å®ä¾‹
- âœ… æ”¯æŒ Realm å’Œ SQLite ä¸¤ç§å®ç°
- âœ… è‡ªåŠ¨åˆå§‹åŒ–æ•°æ®åº“

#### ä½¿ç”¨æ–¹å¼
```swift
// åˆ›å»º SQLite æ•°æ®åº“ï¼ˆæ¨èï¼‰
let database = try IMDatabaseFactory.createDatabase(
    type: .sqlite,
    userID: "user_123"
)

// æˆ–è€…ä½¿ç”¨é…ç½®åˆ›å»º
let config = IMDatabaseConfig(type: .sqlite)
let database = try IMDatabaseFactory.createDatabase(
    config: config,
    userID: "user_123"
)
```

---

### 3. å®ç°åè®® âœ¨
**æ–‡ä»¶**: 
- `IMDatabaseManager+Protocol.swift`
- `IMDatabaseManager.swift`ï¼ˆæ·»åŠ  extensionï¼‰

#### åŠŸèƒ½
- âœ… SQLite æ•°æ®åº“ç®¡ç†å™¨å®ç°åè®®
- âœ… Realm æ•°æ®åº“ç®¡ç†å™¨å®ç°åè®®
- âœ… è¡¥å……ç¼ºå¤±çš„æ–¹æ³•ï¼ˆåŒæ­¥é…ç½®æ“ä½œï¼‰
- âœ… ä¿æŒ API ä¸€è‡´æ€§

#### å®ç°æ–¹å¼
```swift
// SQLite å®ç°
extension IMDatabaseManager: IMDatabaseProtocol {
    // å·²æœ‰æ–¹æ³•è‡ªåŠ¨æ»¡è¶³åè®®
    // è¡¥å……ç¼ºå¤±æ–¹æ³•
}

// Realm å®ç°
extension IMDatabaseManager: IMDatabaseProtocol {
    // å·²æœ‰æ–¹æ³•è‡ªåŠ¨æ»¡è¶³åè®®
}
```

---

### 4. ä¿®æ”¹ IMClient âœ¨
**æ–‡ä»¶**: `IMClient.swift`

#### æ”¹åŠ¨
- âœ… ä½¿ç”¨åè®®ç±»å‹ä»£æ›¿å…·ä½“ç±»å‹
- âœ… ä½¿ç”¨å·¥å‚æ¨¡å¼åˆ›å»ºæ•°æ®åº“å®ä¾‹
- âœ… æ”¯æŒé…ç½®é€‰æ‹©æ•°æ®åº“ç±»å‹
- âœ… ä¿æŒå‘åå…¼å®¹

#### Beforeï¼ˆä¿®æ”¹å‰ï¼‰
```swift
private var databaseManager: IMDatabaseManager

private init() {
    self.databaseManager = IMDatabaseManager.shared
}
```

#### Afterï¼ˆä¿®æ”¹åï¼‰
```swift
private var databaseManager: IMDatabaseProtocol?  // ä½¿ç”¨åè®®ç±»å‹

private init() {
    // æ•°æ®åº“åœ¨ login æ—¶åŠ¨æ€åˆ›å»º
}

public func login(...) {
    // ä½¿ç”¨å·¥å‚æ¨¡å¼åˆ›å»ºæ•°æ®åº“
    self.databaseManager = try IMDatabaseFactory.createDatabase(
        config: config!.databaseConfig,
        userID: userID
    )
}
```

---

### 5. æ›´æ–°ä¸šåŠ¡å±‚ç®¡ç†å™¨ âœ¨

#### è‡ªåŠ¨å…¼å®¹
æ‰€æœ‰ä¸šåŠ¡å±‚ç®¡ç†å™¨ï¼ˆIMMessageManagerã€IMConversationManagerç­‰ï¼‰éƒ½æ¥å—åè®®ç±»å‹ï¼Œæ— éœ€ä¿®æ”¹ï¼š

```swift
self.messageManager = IMMessageManager(
    database: database,  // åè®®ç±»å‹
    protocolHandler: protocolHandler,
    websocket: wsManager
)

self.conversationManager = IMConversationManager(
    database: database,  // åè®®ç±»å‹
    messageManager: messageManager
)

// å…¶ä»–ç®¡ç†å™¨åŒç†
```

---

## ğŸ“Š é›†æˆæ¶æ„

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    IMClient                         â”‚
â”‚                  (ä¸šåŠ¡å±‚å…¥å£)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ ä½¿ç”¨å·¥å‚åˆ›å»º
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              IMDatabaseFactory                       â”‚
â”‚           (æ ¹æ®é…ç½®åˆ›å»ºæ•°æ®åº“å®ä¾‹)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                             â”‚
        â–¼                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IMDatabaseManagerâ”‚      â”‚IMSQLiteDatabaseMgrâ”‚
â”‚   (Realmå®ç°)    â”‚      â”‚ (SQLiteå®ç°) â­  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ å®ç°
                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   IMDatabaseProtocol         â”‚
        â”‚    (ç»Ÿä¸€æ•°æ®åº“æ¥å£)          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚              â”‚              â”‚
        â–¼              â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚IMMessageMgr  â”‚â”‚IConversationMgrâ”‚â”‚IUserMgr  â”‚
â”‚              â”‚â”‚              â”‚â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ ä½¿ç”¨æŒ‡å—

### 1. ä½¿ç”¨ SQLiteï¼ˆæ¨èï¼Œé»˜è®¤ï¼‰

```swift
import IMSDK

// åˆ›å»ºé…ç½®ï¼ˆé»˜è®¤ä½¿ç”¨ SQLiteï¼‰
let config = IMConfig(
    apiURL: "https://api.example.com",
    wsURL: "wss://ws.example.com",
    databaseConfig: IMDatabaseConfig(type: .sqlite)  // é»˜è®¤å€¼
)

// åˆå§‹åŒ– SDK
try IMClient.shared.initialize(config: config)

// ç™»å½•ï¼ˆè‡ªåŠ¨ä½¿ç”¨ SQLite æ•°æ®åº“ï¼‰
IMClient.shared.login(
    userID: "user_123",
    token: "your_token"
) { result in
    switch result {
    case .success(let user):
        print("ç™»å½•æˆåŠŸï¼Œä½¿ç”¨ SQLite + WAL æ•°æ®åº“")
    case .failure(let error):
        print("ç™»å½•å¤±è´¥: \(error)")
    }
}
```

### 2. ä½¿ç”¨ Realmï¼ˆå…¼å®¹æ¨¡å¼ï¼‰

```swift
import IMSDK

// åˆ›å»ºé…ç½®ï¼ˆæŒ‡å®šä½¿ç”¨ Realmï¼‰
let config = IMConfig(
    apiURL: "https://api.example.com",
    wsURL: "wss://ws.example.com",
    databaseConfig: IMDatabaseConfig(type: .realm)  // ä½¿ç”¨ Realm
)

// åˆå§‹åŒ–å’Œç™»å½•åŒä¸Š
```

### 3. æ•°æ®åº“åŠ å¯†ï¼ˆå¯é€‰ï¼‰

```swift
// ç”ŸæˆåŠ å¯†å¯†é’¥
let encryptionKey = Data(count: 64)  // 64å­—èŠ‚å¯†é’¥

let config = IMConfig(
    apiURL: "https://api.example.com",
    wsURL: "wss://ws.example.com",
    databaseConfig: IMDatabaseConfig(
        type: .sqlite,
        enableEncryption: true,
        encryptionKey: encryptionKey
    )
)
```

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

### å†™å…¥æ€§èƒ½

| æ“ä½œ | Realm | SQLite + WAL | æå‡ |
|------|-------|-------------|------|
| å•æ¡å†™å…¥ | ~15ms | **~5ms** | **3x** âš¡ |
| æ‰¹é‡å†™å…¥(100) | ~1500ms | **~150ms** | **10x** âš¡ |

### æŸ¥è¯¢æ€§èƒ½

| æ“ä½œ | Realm | SQLite + WAL | æå‡ |
|------|-------|-------------|------|
| æŸ¥è¯¢(20æ¡) | ~5ms | **~3-5ms** | ç›¸å½“ |
| æœç´¢(500æ¡) | N/A | **~30ms** | ä¼˜ç§€ âš¡ |

### å¹¶å‘æ€§èƒ½

| æ“ä½œ | Realm | SQLite + WAL | ä¼˜åŠ¿ |
|------|-------|-------------|------|
| å¹¶å‘è¯» | âŒ é˜»å¡ | âœ… **ä¸é˜»å¡** | **WAL æ¨¡å¼** âš¡ |
| è¯»å†™å¹¶å‘ | âŒ äº’æ–¥ | âœ… **ä¸äº’æ–¥** | **æ˜¾è‘—æå‡** âš¡ |

---

## ğŸ¯ è¿ç§»æŒ‡å—

### ä» Realm è¿ç§»åˆ° SQLite

#### æ­¥éª¤ 1ï¼šæ›´æ–°é…ç½®
```swift
// æ—§ä»£ç ï¼ˆRealmï¼‰
let config = IMConfig(
    apiURL: "...",
    wsURL: "..."
)

// æ–°ä»£ç ï¼ˆSQLiteï¼Œæ¨èï¼‰
let config = IMConfig(
    apiURL: "...",
    wsURL: "...",
    databaseConfig: IMDatabaseConfig(type: .sqlite)
)
```

#### æ­¥éª¤ 2ï¼šé‡æ–°ç™»å½•
```swift
// ç”¨æˆ·é‡æ–°ç™»å½•æ—¶ä¼šè‡ªåŠ¨ä½¿ç”¨æ–°çš„æ•°æ®åº“
IMClient.shared.login(userID: "...", token: "...") { result in
    // ç™»å½•æˆåŠŸåä½¿ç”¨ SQLite æ•°æ®åº“
}
```

#### æ­¥éª¤ 3ï¼šæ•°æ®è¿ç§»ï¼ˆå¯é€‰ï¼‰
å¦‚æœéœ€è¦è¿ç§»æ—§æ•°æ®ï¼š
```swift
// TODO: å®ç°æ•°æ®è¿ç§»å·¥å…·
// ä» Realm æ•°æ®åº“å¯¼å‡ºæ•°æ®
// å¯¼å…¥åˆ° SQLite æ•°æ®åº“
```

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### 1. åè®®è®¾è®¡

åè®®åŒ…å«æ‰€æœ‰æ•°æ®åº“æ“ä½œæ–¹æ³•ï¼š
- âœ… æ¶ˆæ¯ CRUDï¼ˆ15+ æ–¹æ³•ï¼‰
- âœ… ä¼šè¯ CRUDï¼ˆ10+ æ–¹æ³•ï¼‰
- âœ… ç”¨æˆ· CRUDï¼ˆ6+ æ–¹æ³•ï¼‰
- âœ… ç¾¤ç»„ CRUDï¼ˆ8+ æ–¹æ³•ï¼‰
- âœ… å¥½å‹ CRUDï¼ˆ7+ æ–¹æ³•ï¼‰
- âœ… åŒæ­¥é…ç½®ï¼ˆ3+ æ–¹æ³•ï¼‰

### 2. å·¥å‚æ¨¡å¼

æ ¹æ®é…ç½®åŠ¨æ€åˆ›å»ºæ•°æ®åº“å®ä¾‹ï¼š
```swift
public static func createDatabase(
    type: IMDatabaseType,
    userID: String
) throws -> IMDatabaseProtocol {
    switch type {
    case .realm:
        return IMDatabaseManager.shared
    case .sqlite:
        return try IMDatabaseManager(userID: userID)
    }
}
```

### 3. å‘åå…¼å®¹

- âœ… ä¿æŒåŸæœ‰ API ä¸å˜
- âœ… æ”¯æŒ Realm å’Œ SQLite åˆ‡æ¢
- âœ… ä¸šåŠ¡å±‚æ— æ„ŸçŸ¥åˆ‡æ¢
- âœ… é…ç½®çµæ´»å¯æ§

---

## âœ… é›†æˆå®Œæˆæƒ…å†µ

### æ ¸å¿ƒæ–‡ä»¶ï¼ˆ5ä¸ªæ–°æ–‡ä»¶ï¼‰

- [x] IMDatabaseProtocol.swiftï¼ˆ250+ è¡Œï¼‰
- [x] IMDatabaseFactory.swiftï¼ˆ40+ è¡Œï¼‰
- [x] IMDatabaseManager+Protocol.swiftï¼ˆ100+ è¡Œï¼‰
- [x] IMDatabaseManager.swiftï¼ˆæ·»åŠ  extensionï¼‰
- [x] IMClient.swiftï¼ˆä¿®æ”¹ä½¿ç”¨åè®®ç±»å‹ï¼‰

### ä¿®æ”¹çš„æ–‡ä»¶ï¼ˆ2ä¸ªï¼‰

- [x] IMClient.swift
  - ä½¿ç”¨åè®®ç±»å‹
  - ä½¿ç”¨å·¥å‚æ¨¡å¼åˆ›å»ºæ•°æ®åº“
  - åŠ¨æ€é€‰æ‹©æ•°æ®åº“ç±»å‹

- [x] IMDatabaseManager.swift
  - æ·»åŠ åè®®å®ç°å£°æ˜
  - åˆ é™¤æ—§çš„ IMDatabaseConfig å®šä¹‰

### ä¸šåŠ¡å±‚ç®¡ç†å™¨ï¼ˆè‡ªåŠ¨å…¼å®¹ï¼‰

- [x] IMMessageManager âœ…
- [x] IMMessageSyncManager âœ…
- [x] IMConversationManager âœ…
- [x] IMUserManager âœ…
- [x] IMGroupManager âœ…
- [x] IMFriendManager âœ…

---

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒæˆæœ

1. âœ… **åˆ›å»ºç»Ÿä¸€æ•°æ®åº“åè®®** - æ”¯æŒå¤šç§å®ç°
2. âœ… **å®ç°å·¥å‚æ¨¡å¼** - åŠ¨æ€åˆ›å»ºæ•°æ®åº“å®ä¾‹
3. âœ… **é›†æˆåˆ° IMClient** - å¹³æ»‘æ›¿æ¢æ•°æ®åº“
4. âœ… **ä¿æŒå‘åå…¼å®¹** - æ”¯æŒ Realm å’Œ SQLite
5. âœ… **0 ç¼–è¯‘é”™è¯¯** - é›†æˆæˆåŠŸ

### æŠ€æœ¯äº®ç‚¹

1. âœ… **åè®®å¯¼å‘ç¼–ç¨‹** - è§£è€¦ä¸šåŠ¡å±‚å’Œæ•°æ®å±‚
2. âœ… **å·¥å‚æ¨¡å¼** - çµæ´»åˆ›å»ºæ•°æ®åº“å®ä¾‹
3. âœ… **å‘åå…¼å®¹** - å¹³æ»‘è¿ç§»
4. âœ… **é»˜è®¤æ¨è** - SQLite + WAL ä½œä¸ºé»˜è®¤é€‰é¡¹

### é¡¹ç›®ä»·å€¼

1. âœ… **æ€§èƒ½æå‡** - å†™å…¥é€Ÿåº¦å¿« 3-10 å€
2. âœ… **å¹¶å‘ä¼˜åŒ–** - è¯»å†™ä¸äº’æ–¥
3. âœ… **çµæ´»å¯æ§** - æ”¯æŒå¤šç§æ•°æ®åº“
4. âœ… **å¹³æ»‘è¿ç§»** - ä¸šåŠ¡å±‚æ— æ„ŸçŸ¥

---

## ğŸš€ ä¸‹ä¸€æ­¥å·¥ä½œ

### ç«‹å³è¿›è¡Œ
- [ ] åˆ›å»ºé›†æˆæµ‹è¯•
- [ ] æ€§èƒ½å¯¹æ¯”æµ‹è¯•
- [ ] æ›´æ–°ä½¿ç”¨æ–‡æ¡£

### è¿‘æœŸè®¡åˆ’
- [ ] å®ç°æ•°æ®è¿ç§»å·¥å…·ï¼ˆRealm â†’ SQLiteï¼‰
- [ ] ç°åº¦å‘å¸ƒç­–ç•¥
- [ ] ç”Ÿäº§ç¯å¢ƒç›‘æ§

---

**å®Œæˆæ—¶é—´**: 2025-10-25  
**é›†æˆæ–‡ä»¶**: 5 ä¸ªæ–°æ–‡ä»¶ + 2 ä¸ªä¿®æ”¹  
**ç¼–è¯‘çŠ¶æ€**: âœ… æ— é”™è¯¯  
**é›†æˆçŠ¶æ€**: âœ… å®Œæˆ

ğŸ‰ **SQLite é›†æˆåˆ°ä¸šåŠ¡å±‚å·²å…¨éƒ¨å®Œæˆï¼é»˜è®¤ä½¿ç”¨ SQLite + WAL æ•°æ®åº“ï¼**

