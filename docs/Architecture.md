# IMSDK 架构设计文档

## 目录

1. [总体架构](#总体架构)
2. [分层设计](#分层设计)
3. [核心组件](#核心组件)
4. [数据流转](#数据流转)
5. [性能优化](#性能优化)
6. [安全设计](#安全设计)
7. [扩展性设计](#扩展性设计)

---

## 总体架构

IMSDK 采用分层架构设计，从下到上分为四层：

```
┌─────────────────────────────────────────────┐
│          应用层 (Application Layer)           │
│          使用 SDK 的应用程序                   │
└─────────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────┐
│          接口层 (API Layer)                   │
│    IMClient - 主入口和委托                   │
└─────────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────┐
│          业务层 (Business Layer)              │
│  MessageManager  ConversationManager        │
│  UserManager     GroupManager               │
│  FriendManager   ...                        │
└─────────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────┐
│          核心层 (Core Layer)                  │
│  NetworkManager  DatabaseManager            │
│  ProtocolHandler SyncManager                │
└─────────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────┐
│          基础层 (Foundation Layer)            │
│  Logger  Crypto  Cache  Utils               │
└─────────────────────────────────────────────┘
```

---

## 分层设计

### 1. 基础层 (Foundation Layer)

**职责：** 提供基础工具和服务

**组件：**
- **IMLogger**: 日志系统，支持多级别日志和文件输出
- **IMCrypto**: 加密工具，提供 AES、SHA256、MD5、HMAC 等加密功能
- **IMCache**: 缓存管理，包括内存缓存和磁盘缓存
- **IMUtils**: 通用工具类，提供 UUID 生成、时间处理、JSON 转换等

**设计原则：**
- 无依赖：不依赖上层组件
- 可复用：可在其他项目中独立使用
- 高性能：底层组件需要高效执行

### 2. 核心层 (Core Layer)

**职责：** 提供核心功能实现

**组件：**

#### IMNetworkManager
- **IMHTTPManager**: HTTP 请求管理
  - RESTful API 调用
  - 文件上传下载
  - 请求重试和超时处理
  
- **IMWebSocketManager**: WebSocket 连接管理
  - 长连接维护
  - 断线重连
  - Ping/Pong 心跳机制（每 30 秒，带超时检测）
  - 消息收发

#### IMDatabaseManager
- 基于 Realm 的本地数据库
- 支持加密存储
- 提供 CRUD 接口
- 事务支持

#### IMProtocolHandler
- 消息协议编解码
- 消息序列号管理
- 请求-响应匹配
- 消息队列管理

**设计原则：**
- 高可用：支持断线重连和容错
- 高性能：优化网络和数据库操作
- 线程安全：所有核心组件都是线程安全的

### 3. 业务层 (Business Layer)

**职责：** 实现具体的业务逻辑

**组件：**

#### IMMessageManager
- 消息发送和接收
- 消息状态管理
- 消息队列
- 已读回执

#### IMConversationManager
- 会话列表管理
- 未读数统计
- 草稿管理
- 会话置顶

#### IMUserManager
- 用户信息管理
- 用户信息缓存
- 批量获取用户信息

#### IMGroupManager
- 群组创建和解散
- 成员管理
- 群组信息更新

#### IMFriendManager
- 好友添加和删除
- 好友请求处理
- 好友备注管理

**设计原则：**
- 高内聚：每个 Manager 专注于自己的业务
- 低耦合：Manager 之间通过接口通信
- 可测试：便于单元测试

### 4. 接口层 (API Layer)

**职责：** 对外提供统一的 SDK 接口

**组件：**

#### IMClient
- SDK 初始化和配置
- 登录登出
- 监听器管理
- 连接状态管理
- 提供对各业务 Manager 的访问

**设计原则：**
- 简单易用：提供清晰的 API
- 一致性：保持 API 风格一致
- 向后兼容：新版本保持兼容性

---

## 核心组件

### 消息可靠性保证

```
发送流程：
┌─────────┐    ┌─────────┐    ┌──────────┐    ┌────────┐
│ 应用层  │───▶│ 本地DB  │───▶│ 消息队列 │───▶│ 服务器 │
└─────────┘    └─────────┘    └──────────┘    └────────┘
                                      │
                                      ▼
                                ┌──────────┐
                                │ 重试机制 │
                                └──────────┘

接收流程：
┌────────┐    ┌──────────┐    ┌─────────┐    ┌─────────┐
│ 服务器 │───▶│ 协议解析 │───▶│ 本地DB  │───▶│ 应用层  │
└────────┘    └──────────┘    └─────────┘    └─────────┘
                                      │
                                      ▼
                                ┌──────────┐
                                │ 发送ACK  │
                                └──────────┘
```

### 缓存策略

**三级缓存：**
1. 内存缓存（IMMemoryCache）
   - LRU 淘汰策略
   - 限制数量和大小
   - 支持过期时间

2. 数据库缓存（Realm）
   - 持久化存储
   - 加密保护
   - 快速查询

3. 服务器（HTTP API）
   - 强制更新时访问
   - 缓存失效时访问

**缓存读取顺序：**
```
内存缓存 → 数据库缓存 → 服务器
```

### 连接管理

**连接状态机：**
```
          ┌────────────┐
          │ Disconnected│
          └──────┬─────┘
                 │ connect()
                 ▼
          ┌────────────┐
          │ Connecting  │
          └──────┬─────┘
                 │ onConnected
                 ▼
          ┌────────────┐
  ┌───────┤ Connected   ├───────┐
  │       └──────┬─────┘       │
  │              │ onError     │ disconnect()
  │              ▼             │
  │       ┌────────────┐       │
  └──────▶│Reconnecting│       │
          └──────┬─────┘       │
                 │             │
                 └─────────────┘
```

**断线重连策略：**
- 指数退避算法
- 最大重试次数限制
- 网络状态感知

---

## 数据流转

### 消息发送流程

```
1. 应用调用 sendMessage()
   ↓
2. 生成 clientMsgID，设置状态为 sending
   ↓
3. 保存到本地数据库
   ↓
4. 添加到消息队列
   ↓
5. 编码为协议包
   ↓
6. 通过 WebSocket 发送
   ↓
7. 收到服务器 ACK
   ↓
8. 更新消息状态为 sent/delivered
   ↓
9. 通知应用层
```

### 消息接收流程

```
1. WebSocket 收到数据
   ↓
2. 协议解析
   ↓
3. 提取消息对象
   ↓
4. 保存到本地数据库
   ↓
5. 更新会话（最后一条消息、未读数）
   ↓
6. 通知应用层
   ↓
7. 发送已读回执（如果需要）
```

### 离线消息同步

```
1. 连接成功后触发同步
   ↓
2. 获取本地最大 seq
   ↓
3. 向服务器请求增量消息
   ↓
4. 批量保存到数据库
   ↓
5. 更新相关会话
   ↓
6. 通知应用层
```

---

## 性能优化

### 1. 网络优化

- **连接复用**: WebSocket 长连接复用
- **批量请求**: 批量获取用户信息、消息等
- **压缩传输**: 大数据使用 gzip 压缩
- **CDN 加速**: 图片、文件使用 CDN

### 2. 数据库优化

- **索引优化**: 为常用查询字段添加索引
- **批量操作**: 批量插入、更新
- **延迟写入**: 非关键数据延迟写入
- **分页加载**: 消息列表分页加载

### 3. 内存优化

- **缓存限制**: 限制内存缓存大小
- **及时释放**: 不用的对象及时释放
- **图片压缩**: 图片缩略图压缩
- **内存警告**: 监听系统内存警告

### 4. UI 优化

- **异步加载**: 所有网络和数据库操作异步执行
- **主线程回调**: 回调在主线程执行
- **防抖节流**: UI 操作防抖和节流

---

## 安全设计

### 1. 传输安全

- **HTTPS/WSS**: 使用加密通道
- **Token 认证**: JWT Token 认证
- **签名验证**: 关键接口签名验证

### 2. 存储安全

- **数据库加密**: Realm 数据库加密
- **密钥管理**: 密钥安全存储
- **敏感信息**: 敏感信息加密存储

### 3. 业务安全

- **防重放**: 消息序列号防重放
- **权限验证**: 操作权限验证
- **敏感操作**: 敏感操作二次确认

---

## 扩展性设计

### 1. Protocol-Oriented

使用协议定义接口，便于扩展和替换实现：

```swift
public protocol IMRequest {
    var path: String { get }
    var method: HTTPMethod { get }
    var parameters: [String: Any]? { get }
}
```

### 2. 监听器模式

通过监听器模式解耦业务逻辑：

```swift
public protocol IMMessageListener: AnyObject {
    func onMessageReceived(_ message: IMMessage)
    func onMessageStatusChanged(_ message: IMMessage)
}
```

### 3. 插件化

支持自定义消息类型和扩展功能：

```swift
// 自定义消息
public class CustomMessage: IMMessage {
    // 自定义字段
}

// 注册自定义消息处理器
messageManager.registerMessageHandler(CustomMessageHandler())
```

### 4. 配置化

通过配置控制功能开关：

```swift
public struct IMConfig {
    var enableLogging: Bool = true
    var enableEncryption: Bool = true
    var enableCompression: Bool = true
}
```

---

## 并发处理

### 线程模型

- **主线程**: UI 更新、回调通知
- **网络线程**: WebSocket 连接、HTTP 请求
- **数据库线程**: Realm 读写操作
- **工作线程**: 数据处理、编解码

### 线程安全

- **锁机制**: NSLock、DispatchQueue
- **原子操作**: @ThreadSafe 属性包装器
- **不可变对象**: 尽量使用不可变对象

---

## 测试策略

### 1. 单元测试

- 核心组件单元测试
- 业务逻辑单元测试
- Mock 依赖组件

### 2. 集成测试

- 端到端消息流程测试
- 网络异常场景测试
- 并发场景测试

### 3. 性能测试

- 消息收发性能
- 数据库读写性能
- 内存和 CPU 占用

---

## 监控和日志

### 日志级别

- **Verbose**: 详细调试信息
- **Debug**: 调试信息
- **Info**: 一般信息
- **Warning**: 警告信息
- **Error**: 错误信息

### 监控指标

- 连接成功率
- 消息发送成功率
- API 请求成功率
- 平均响应时间
- 崩溃率

---

## 总结

IMSDK 通过分层架构、模块化设计、缓存优化、安全加密等技术手段，实现了一个高性能、可扩展、易用的企业级 IM SDK。架构设计充分考虑了性能、安全、可维护性和扩展性，能够满足千万级用户的需求。

