# æ’¤å›æ¶ˆæ¯æµç¨‹åˆ†æ

## ğŸ¤” é—®é¢˜

å½“å‰çš„ `revokeMessage` å®ç°å­˜åœ¨ä¸¥é‡çš„æ¶æ„é—®é¢˜ï¼

### âŒ é”™è¯¯çš„å®ç°æ–¹å¼

```swift
public func revokeMessage(messageID: String, completion: @escaping (Result<Void, IMError>) -> Void) {
    // 1. å‘é€æ’¤å›è¯·æ±‚åˆ°æœåŠ¡å™¨
    sendRevokeRequest(request) { result in
        switch result {
        case .success:
            // âŒ é”™è¯¯ï¼šæ”¶åˆ° HTTP/WebSocket å“åº”åç›´æ¥æ›´æ–°æ•°æ®åº“
            self.updateMessageAsRevoked(...)
            self.notifyListeners { listener in
                listener.onMessageRevoked?(message: message)
            }
            completion(.success(()))
        case .failure(let error):
            completion(.failure(error))
        }
    }
}
```

### é—®é¢˜åˆ†æ

| é—®é¢˜ | æè¿° | å½±å“ |
|------|------|------|
| **çŠ¶æ€æ›´æ–°æ–¹å¼ä¸ä¸€è‡´** | å‘é€è€…é€šè¿‡ HTTP å“åº”æ›´æ–°ï¼Œæ¥æ”¶è€…é€šè¿‡ WebSocket æ¨é€æ›´æ–° | ğŸ”´ çŠ¶æ€ä¸ä¸€è‡´é£é™© |
| **é‡å¤å¤„ç†** | å‘é€è€…ä¼šæ”¶åˆ°ä¸¤æ¬¡æ›´æ–°ï¼ˆHTTP å“åº” + WebSocket æ¨é€ï¼‰ | ğŸ”´ éœ€è¦å»é‡é€»è¾‘ |
| **æ—¶åºé—®é¢˜** | HTTP å“åº”å¯èƒ½æ¯” WebSocket æ¨é€æ…¢ | ğŸ”´ çŠ¶æ€å¯èƒ½è¢«è¦†ç›– |
| **å¼‚æ­¥ç­‰å¾…** | éœ€è¦ç­‰å¾…æœåŠ¡å™¨å“åº”æ‰æ›´æ–° UI | ğŸŸ¡ ç”¨æˆ·ä½“éªŒå·® |

---

## âœ… æ­£ç¡®çš„ IM æ¶æ„

### æ ¸å¿ƒåŸåˆ™

```
æ‰€æœ‰çŠ¶æ€å˜æ›´éƒ½åº”è¯¥é€šè¿‡ WebSocket æ¨é€æ¥è§¦å‘ï¼
```

### æ­£ç¡®çš„æµç¨‹

```
ç”¨æˆ· A ç‚¹å‡»"æ’¤å›"
        â†“
IMMessageManager.revokeMessage()
        â†“
å‘é€æ’¤å›è¯·æ±‚åˆ°æœåŠ¡å™¨ï¼ˆç«‹å³è¿”å›ï¼‰âœ…
        â†“
        â”œâ”€ è¿”å› .successï¼ˆè¡¨ç¤ºè¯·æ±‚å·²å‘é€ï¼‰
        â”‚  â†“
        â”‚  UI å¯ä»¥æ˜¾ç¤º"æ’¤å›ä¸­..."ï¼ˆå¯é€‰ï¼‰
        â”‚
        â†“ (æœåŠ¡å™¨å¤„ç†)
        â”‚
æœåŠ¡å™¨å¤„ç†æ’¤å›è¯·æ±‚
        â†“
æœåŠ¡å™¨éªŒè¯æƒé™ã€æ—¶é—´ç­‰
        â†“
æœåŠ¡å™¨æ ‡è®°æ¶ˆæ¯ä¸ºå·²æ’¤å›
        â†“
æœåŠ¡å™¨é€šè¿‡ WebSocket æ¨é€æ’¤å›é€šçŸ¥ç»™æ‰€æœ‰ç›¸å…³ç”¨æˆ·
        â†“
        â”œâ”€ æ¨é€ç»™ç”¨æˆ· Aï¼ˆå‘é€è€…ï¼‰
        â”‚  â†“
        â”‚  handleRevokeNotification()
        â”‚  â†“
        â”‚  æ›´æ–°æ•°æ®åº“ + é€šçŸ¥ UI âœ…
        â”‚
        â””â”€ æ¨é€ç»™ç”¨æˆ· Bï¼ˆæ¥æ”¶è€…ï¼‰
           â†“
           handleRevokeNotification()
           â†“
           æ›´æ–°æ•°æ®åº“ + é€šçŸ¥ UI âœ…
```

### ä¼˜åŠ¿

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| âœ… **çŠ¶æ€ä¸€è‡´** | æ‰€æœ‰ç”¨æˆ·éƒ½é€šè¿‡åŒä¸€ä¸ª WebSocket æ¨é€æ›´æ–°ï¼Œä¿è¯çŠ¶æ€ä¸€è‡´ |
| âœ… **ä»£ç ç®€æ´** | åªæœ‰ä¸€ä¸ªæ›´æ–°æ•°æ®åº“çš„åœ°æ–¹ï¼ˆhandleRevokeNotificationï¼‰ |
| âœ… **å®æ—¶æ€§é«˜** | WebSocket æ¨é€æ¯” HTTP è½®è¯¢å¿« |
| âœ… **æ˜“äºè°ƒè¯•** | æ‰€æœ‰ç”¨æˆ·çš„æ›´æ–°è·¯å¾„ç›¸åŒ |
| âœ… **ç¬¦åˆ IM æ ‡å‡†** | å¾®ä¿¡ã€é’‰é’‰ç­‰éƒ½æ˜¯è¿™æ ·åšçš„ |

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®æ”¹ `revokeMessage` æ–¹æ³•

```swift
/// æ’¤å›æ¶ˆæ¯ï¼ˆåŒæ­¥æ–¹æ³•ï¼‰
/// - Parameters:
///   - messageID: æ¶ˆæ¯ ID
///   - completion: å®Œæˆå›è°ƒï¼ˆç«‹å³è¿”å›ï¼Œåªè¡¨ç¤ºè¯·æ±‚æ˜¯å¦å‘é€æˆåŠŸï¼‰
/// - Note: å®é™…çš„æ’¤å›ç»“æœä¼šé€šè¿‡ WebSocket æ¨é€é€šçŸ¥ï¼ˆhandleRevokeNotificationï¼‰
public func revokeMessage(
    messageID: String,
    completion: @escaping (Result<Void, IMError>) -> Void
) {
    // 1. ä»æ•°æ®åº“è·å–æ¶ˆæ¯
    guard let message = database.getMessage(messageID: messageID) else {
        completion(.failure(.messageNotFound))
        return
    }
    
    // 2. æ£€æŸ¥æ˜¯å¦æ˜¯å‘é€è€…
    guard message.senderID == getCurrentUserID() else {
        completion(.failure(.permissionDenied))
        return
    }
    
    // 3. æ£€æŸ¥æ—¶é—´é™åˆ¶ï¼ˆ2 åˆ†é’Ÿå†…ï¼‰
    let currentTime = Int64(Date().timeIntervalSince1970 * 1000)
    let elapsed = currentTime - message.sendTime
    let revokeTimeLimit: Int64 = 2 * 60 * 1000  // 2 åˆ†é’Ÿ
    
    guard elapsed <= revokeTimeLimit else {
        completion(.failure(.revokeTimeExpired))
        return
    }
    
    // 4. æ„å»ºå¹¶å‘é€æ’¤å›è¯·æ±‚åˆ°æœåŠ¡å™¨
    let request = IMRevokeMessageRequest(
        messageID: messageID,
        conversationID: message.conversationID
    )
    
    // 5. å‘é€è¯·æ±‚ï¼ˆç«‹å³è¿”å›ï¼Œä¸ç­‰å¾…ç»“æœï¼‰
    sendRevokeRequest(request) { result in
        switch result {
        case .success:
            // âœ… åªè¿”å›è¯·æ±‚å‘é€æˆåŠŸï¼Œä¸æ›´æ–°æ•°æ®åº“
            // å®é™…çš„æ•°æ®åº“æ›´æ–°ä¼šåœ¨æ”¶åˆ° WebSocket æ¨é€æ—¶è¿›è¡Œï¼ˆhandleRevokeNotificationï¼‰
            completion(.success(()))
            
        case .failure(let error):
            // âŒ è¯·æ±‚å‘é€å¤±è´¥
            completion(.failure(error))
        }
    }
    
    // âš ï¸ æ³¨æ„ï¼šæ­¤æ—¶æ¶ˆæ¯è¿˜æœªçœŸæ­£æ’¤å›ï¼
    // çœŸæ­£çš„æ’¤å›ä¼šåœ¨æ”¶åˆ°æœåŠ¡å™¨çš„ WebSocket æ¨é€åå®Œæˆ
}
```

### 2. æœåŠ¡å™¨æ¨é€å¤„ç†ï¼ˆå·²æœ‰ï¼‰

```swift
// IMClient.swift
private func handleWebSocketRevokeMessage(_ body: Data, sequence: UInt32) {
    let revokeMsg = try Im_Protocol_RevokeMessagePush(serializedData: body)
    
    // âœ… æ‰€æœ‰ç”¨æˆ·ï¼ˆåŒ…æ‹¬å‘é€è€…ï¼‰éƒ½é€šè¿‡è¿™é‡Œæ›´æ–°
    messageManager?.handleRevokeNotification(
        messageID: revokeMsg.messageID,
        revokerID: revokeMsg.revokedBy,
        revokeTime: revokeMsg.revokedTime
    )
}

// IMMessageManager+P0Features.swift
internal func handleRevokeNotification(messageID: String, revokerID: String, revokeTime: Int64) {
    // 1. æ›´æ–°æ•°æ®åº“
    updateMessageAsRevoked(messageID: messageID, revokerID: revokerID, revokeTime: revokeTime)
    
    // 2. è·å–æ¶ˆæ¯
    guard let message = database.getMessage(messageID: messageID) else { return }
    
    // 3. é€šçŸ¥ç›‘å¬å™¨ï¼ˆUI åˆ·æ–°ï¼‰
    notifyListeners { listener in
        listener.onMessageRevoked?(message: message)
    }
    
    // 4. æ›´æ–°ä¼šè¯
    updateConversationIfNeeded(message: message)
}
```

---

## ğŸ“Š å¯¹æ¯”

### âŒ é”™è¯¯æ–¹å¼ï¼ˆä¿®æ”¹å‰ï¼‰

```
ç”¨æˆ· A æ’¤å›æ¶ˆæ¯
        â†“
å‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨
        â†“
ç­‰å¾…æœåŠ¡å™¨å“åº” (100-500ms)
        â†“
æ”¶åˆ°å“åº”åæ›´æ–°æ•°æ®åº“ âŒ
        â†“
é€šçŸ¥ UI åˆ·æ–°
        â†“
ï¼ˆç¨åï¼‰æ”¶åˆ° WebSocket æ¨é€ âŒ
        â†“
å†æ¬¡æ›´æ–°æ•°æ®åº“ï¼Ÿå»é‡ï¼Ÿæ··ä¹±ï¼âŒ
```

**é—®é¢˜ï¼š**
- ğŸ”´ åŒé‡æ›´æ–°ï¼ˆHTTP å“åº” + WebSocket æ¨é€ï¼‰
- ğŸ”´ éœ€è¦å¤æ‚çš„å»é‡é€»è¾‘
- ğŸ”´ å‘é€è€…å’Œæ¥æ”¶è€…çš„æ›´æ–°è·¯å¾„ä¸åŒ
- ğŸ”´ å¯èƒ½çš„æ—¶åºé—®é¢˜

### âœ… æ­£ç¡®æ–¹å¼ï¼ˆä¿®æ”¹åï¼‰

```
ç”¨æˆ· A æ’¤å›æ¶ˆæ¯
        â†“
å‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨ï¼ˆç«‹å³è¿”å›ï¼‰âœ…
        â†“
UI æ˜¾ç¤º"å‘é€ä¸­"ï¼ˆå¯é€‰ï¼‰
        â†“
ï¼ˆç­‰å¾…æœåŠ¡å™¨å¤„ç†...ï¼‰
        â†“
æ”¶åˆ° WebSocket æ¨é€ âœ…
        â†“
æ›´æ–°æ•°æ®åº“ï¼ˆå”¯ä¸€å…¥å£ï¼‰âœ…
        â†“
é€šçŸ¥ UI åˆ·æ–°
```

**ä¼˜ç‚¹ï¼š**
- âœ… å•ä¸€æ›´æ–°è·¯å¾„
- âœ… å‘é€è€…å’Œæ¥æ”¶è€…é€»è¾‘ä¸€è‡´
- âœ… ä¸éœ€è¦å»é‡
- âœ… ä»£ç ç®€æ´

---

## ğŸ¨ UI å±‚æœ€ä½³å®è·µ

### ç”¨æˆ·ä½“éªŒä¼˜åŒ–

```swift
// UI å±‚ä»£ç ç¤ºä¾‹
class ChatViewController {
    func onRevokeButtonTapped(messageID: String) {
        // 1. ç«‹å³æ˜¾ç¤º"æ’¤å›ä¸­"çŠ¶æ€ï¼ˆä¹è§‚æ›´æ–°ï¼‰
        updateMessageUI(messageID: messageID, status: .revoking)
        
        // 2. å‘é€æ’¤å›è¯·æ±‚
        IMClient.shared.messageManager?.revokeMessage(messageID: messageID) { result in
            switch result {
            case .success:
                // âœ… è¯·æ±‚å‘é€æˆåŠŸï¼Œç­‰å¾… WebSocket æ¨é€
                print("æ’¤å›è¯·æ±‚å·²å‘é€ï¼Œç­‰å¾…æœåŠ¡å™¨ç¡®è®¤...")
                // ä¸æ›´æ–° UIï¼ç­‰å¾… onMessageRevoked å›è°ƒ
                
            case .failure(let error):
                // âŒ è¯·æ±‚å‘é€å¤±è´¥ï¼Œæ¢å¤åŸçŠ¶æ€
                self.updateMessageUI(messageID: messageID, status: .normal)
                self.showError("æ’¤å›å¤±è´¥: \(error)")
            }
        }
    }
}

// IMMessageListener
extension ChatViewController: IMMessageListener {
    func onMessageRevoked(message: IMMessage) {
        // âœ… æ”¶åˆ° WebSocket æ¨é€åçš„çœŸæ­£æ›´æ–°
        updateMessageUI(messageID: message.messageID, status: .revoked)
        showToast("æ¶ˆæ¯å·²æ’¤å›")
    }
}
```

---

## ğŸš€ ç±»æ¯”ï¼šå‘é€æ¶ˆæ¯çš„æµç¨‹

æ’¤å›æ¶ˆæ¯çš„æµç¨‹åº”è¯¥å’Œ**å‘é€æ¶ˆæ¯**çš„æµç¨‹ä¸€è‡´ï¼

### å‘é€æ¶ˆæ¯

```
ç”¨æˆ·å‘é€æ¶ˆæ¯
    â†“
IMMessageManager.sendMessage()
    â†“
æ¶ˆæ¯åŠ å…¥å‘é€é˜Ÿåˆ—ï¼ˆçŠ¶æ€ï¼šsendingï¼‰âœ…
    â†“
ç«‹å³è¿”å› .successï¼ˆè¡¨ç¤ºå·²åŠ å…¥é˜Ÿåˆ—ï¼‰âœ…
    â†“
ï¼ˆåå°å‘é€åˆ°æœåŠ¡å™¨...ï¼‰
    â†“
æ”¶åˆ°æœåŠ¡å™¨ ACK
    â†“
æ›´æ–°æ¶ˆæ¯çŠ¶æ€ä¸º .sent âœ…
```

### æ’¤å›æ¶ˆæ¯ï¼ˆåº”è¯¥ç±»ä¼¼ï¼‰

```
ç”¨æˆ·æ’¤å›æ¶ˆæ¯
    â†“
IMMessageManager.revokeMessage()
    â†“
å‘é€æ’¤å›è¯·æ±‚åˆ°æœåŠ¡å™¨ âœ…
    â†“
ç«‹å³è¿”å› .successï¼ˆè¡¨ç¤ºè¯·æ±‚å·²å‘é€ï¼‰âœ…
    â†“
ï¼ˆç­‰å¾…æœåŠ¡å™¨å¤„ç†...ï¼‰
    â†“
æ”¶åˆ° WebSocket æ¨é€
    â†“
æ›´æ–°æ¶ˆæ¯çŠ¶æ€ä¸º .revoked âœ…
```

**ä¸€è‡´æ€§åŸåˆ™ï¼š** æ‰€æœ‰çŠ¶æ€å˜æ›´éƒ½é€šè¿‡æ¨é€æ¥è§¦å‘ï¼

---

## ğŸ’¡ æ€»ç»“

### æ ¸å¿ƒè®¾è®¡åŸåˆ™

1. **è¯·æ±‚å‘é€ â‰  æ“ä½œå®Œæˆ**
   - `revokeMessage` è¿”å›æˆåŠŸ = è¯·æ±‚å·²å‘é€
   - çœŸæ­£æ’¤å›æˆåŠŸ = æ”¶åˆ° WebSocket æ¨é€

2. **ç»Ÿä¸€çš„çŠ¶æ€æ›´æ–°è·¯å¾„**
   - æ‰€æœ‰ç”¨æˆ·éƒ½é€šè¿‡ `handleRevokeNotification` æ›´æ–°
   - é¿å…å¤šè·¯å¾„å¯¼è‡´çš„ä¸ä¸€è‡´

3. **å®æ—¶æ€§ä¸ä¸€è‡´æ€§**
   - WebSocket æ¨é€ä¿è¯æ‰€æœ‰ç”¨æˆ·åŒæ­¥
   - ä¸ä¾èµ– HTTP å“åº”æ›´æ–°çŠ¶æ€

### ä¿®æ”¹æ¸…å•

- âœ… ä¿®æ”¹ `revokeMessage` æ–¹æ³•ï¼Œç§»é™¤å†…éƒ¨çš„æ•°æ®åº“æ›´æ–°é€»è¾‘
- âœ… ä¿®æ”¹æ³¨é‡Šï¼Œæ˜ç¡®è¯´æ˜æµç¨‹
- âœ… ä¿ç•™ `handleRevokeNotification`ï¼Œä½œä¸ºå”¯ä¸€çš„æ•°æ®åº“æ›´æ–°å…¥å£

**è¿™æ ·çš„è®¾è®¡æ‰æ˜¯æ­£ç¡®çš„ IM æ¶æ„ï¼** ğŸ‰

