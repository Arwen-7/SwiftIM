# ä¸¤ç§æ¶ˆæ¯åŒæ­¥æœºåˆ¶å¯¹æ¯”

## âš ï¸ é‡è¦æ›´æ­£

ä¹‹å‰çš„è§£é‡Šæœ‰**ä¸¥é‡é”™è¯¯**ï¼è¿™ä¸¤ä¸ªæ–¹æ³•æ˜¯**å®Œå…¨ä¸åŒ**çš„åŒæ­¥æœºåˆ¶ï¼Œå¹¶éè¯·æ±‚-å“åº”å…³ç³»ã€‚

---

## ğŸ¯ çœŸç›¸æ­æ™“

### æœºåˆ¶ 1ï¼šHTTP ä¸»åŠ¨æ‹‰å– (Pull)

```swift
// IMClient.swift: syncOfflineMessagesAfterReconnect()
private func syncOfflineMessagesAfterReconnect() {
    let localMaxSeq = database.getMaxSeq()
    
    // âœ… é€šè¿‡ HTTP è¯·æ±‚ä¸»åŠ¨æ‹‰å–ç¦»çº¿æ¶ˆæ¯
    messageSyncManager?.sync(fromSeq: localMaxSeq + 1) { result in
        // ...
    }
}
```

**å®ç°ç»†èŠ‚ï¼š**

```swift
// IMMessageSyncManager.swift: sync(fromSeq:)
public func sync(fromSeq: Int64, completion: IMSyncCompletionHandler?) {
    // ...
    performIncrementalSync(fromSeq: fromSeq, completion: completion)
}

private func performIncrementalSync(...) {
    // åˆ†æ‰¹åŒæ­¥
    syncBatch(lastSeq: fromSeq, ...)
}

private func syncBatch(...) {
    // âš ï¸ å…³é”®ï¼šä½¿ç”¨ HTTP è¯·æ±‚ï¼
    httpManager.syncMessages(lastSeq: lastSeq, count: batchSize) { result in
        // å¤„ç† HTTP å“åº”
    }
}
```

**åè®®ï¼š** HTTP/HTTPS  
**æ–¹å‘ï¼š** å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ (Pull)  
**è§¦å‘ï¼š** å®¢æˆ·ç«¯ä¸»åŠ¨å‘èµ·

---

### æœºåˆ¶ 2ï¼šWebSocket æœåŠ¡å™¨æ¨é€ (Push)

```swift
// IMClient.swift: handleWebSocketSyncResponse()
private func handleWebSocketSyncResponse(_ body: Data, sequence: UInt32) {
    // âœ… è§£ææœåŠ¡å™¨é€šè¿‡ WebSocket æ¨é€è¿‡æ¥çš„åŒæ­¥æ¶ˆæ¯
    let syncRsp = try Im_Protocol_SyncResponse(serializedData: body)
    
    // è½¬æ¢å¹¶ä¿å­˜æ¶ˆæ¯
    var imMessages: [IMMessage] = []
    for pbMsg in syncRsp.messages {
        // è½¬æ¢ Protobuf â†’ IMMessage
    }
    
    // ä¼ é€’ç»™åŒæ­¥ç®¡ç†å™¨å¤„ç†
    messageSyncManager?.handleSyncResponse(
        messages: imMessages,
        serverMaxSeq: syncRsp.serverMaxSeq,
        hasMore: syncRsp.hasMore
    )
}
```

**åè®®ï¼š** WebSocket  
**æ–¹å‘ï¼š** æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ (Push)  
**è§¦å‘ï¼š** æœåŠ¡å™¨ä¸»åŠ¨æ¨é€

---

## ğŸ“Š å¯¹æ¯”è¡¨æ ¼

| ç»´åº¦ | HTTP ä¸»åŠ¨æ‹‰å– | WebSocket æ¨é€ |
|------|--------------|---------------|
| **æ–¹æ³•** | `syncOfflineMessagesAfterReconnect()` | `handleWebSocketSyncResponse()` |
| **åè®®** | HTTP/HTTPS | WebSocket |
| **æ–¹å‘** | å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ (Pull) | æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ (Push) |
| **è§¦å‘æ—¶æœº** | å®¢æˆ·ç«¯é‡è¿åä¸»åŠ¨æ‹‰å– | æœåŠ¡å™¨æ£€æµ‹åˆ°æœ‰æ–°æ¶ˆæ¯æ—¶æ¨é€ |
| **ä½¿ç”¨åœºæ™¯** | ç¦»çº¿æ¶ˆæ¯åŒæ­¥ã€æ–­çº¿é‡è¿ | å®æ—¶æ¶ˆæ¯æ¨é€ã€åœ¨çº¿æ¶ˆæ¯ |
| **å®ç°ç±»** | `IMMessageSyncManager` (ä½¿ç”¨ `httpManager`) | `IMClient` (å¤„ç† WebSocket æ¶ˆæ¯) |
| **ä¼˜ç‚¹** | å¯æ§ã€å¯é‡è¯•ã€åˆ†é¡µåŠ è½½ | å®æ—¶æ€§é«˜ã€çœæµé‡ |
| **ç¼ºç‚¹** | å®æ—¶æ€§å·®ã€éœ€è½®è¯¢æˆ–æ‰‹åŠ¨è§¦å‘ | ä¾èµ–é•¿è¿æ¥ã€æœåŠ¡å™¨å‹åŠ›å¤§ |

---

## ğŸ” å®Œæ•´æµç¨‹å›¾

### åœºæ™¯ï¼šç”¨æˆ·æ–­ç½‘ 1 å°æ—¶åé‡è¿

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·é‡è¿                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  handleTransportConnected()                                  â”‚
â”‚  - æ›´æ–°çŠ¶æ€ä¸º .connected                                     â”‚
â”‚  - è§¦å‘ç¦»çº¿æ¶ˆæ¯åŒæ­¥                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                   â”‚
        â–¼                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœºåˆ¶ 1: HTTP ä¸»åŠ¨æ‹‰å–   â”‚    â”‚  æœºåˆ¶ 2: WebSocket æ¨é€      â”‚
â”‚                          â”‚    â”‚                              â”‚
â”‚  syncOfflineMessages     â”‚    â”‚  (æœåŠ¡å™¨å¯èƒ½ä¼šä¸»åŠ¨æ¨é€)      â”‚
â”‚  AfterReconnect()        â”‚    â”‚                              â”‚
â”‚         â†“                â”‚    â”‚  handleWebSocketSync         â”‚
â”‚  messageSyncManager      â”‚    â”‚  Response()                  â”‚
â”‚    .sync(fromSeq:)       â”‚    â”‚         â†“                    â”‚
â”‚         â†“                â”‚    â”‚  è§£æ Protobuf æ¶ˆæ¯          â”‚
â”‚  httpManager             â”‚    â”‚         â†“                    â”‚
â”‚    .syncMessages()       â”‚    â”‚  è½¬æ¢ä¸º IMMessage            â”‚
â”‚         â†“                â”‚    â”‚         â†“                    â”‚
â”‚  å‘é€ HTTP POST è¯·æ±‚     â”‚    â”‚  ä¿å­˜åˆ°æ•°æ®åº“                â”‚
â”‚         â†“                â”‚    â”‚                              â”‚
â”‚  æ¥æ”¶ HTTP å“åº”          â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚         â†“                â”‚
â”‚  å¤„ç†å¹¶ä¿å­˜æ¶ˆæ¯          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ä¸¤ç§æœºåˆ¶ï¼Ÿ

### 1. **äº’è¡¥æ€§**

| æœºåˆ¶ | é€‚ç”¨åœºæ™¯ |
|------|----------|
| **HTTP Pull** | ç¦»çº¿æœŸé—´çš„æ¶ˆæ¯ï¼ˆå†å²æ¶ˆæ¯ã€æ–­çº¿é‡è¿ï¼‰ |
| **WebSocket Push** | åœ¨çº¿æœŸé—´çš„å®æ—¶æ¶ˆæ¯ï¼ˆå³æ—¶é€šè®¯ï¼‰ |

### 2. **å¯é æ€§**

- **WebSocket å¤±è´¥æ—¶**ï¼šå¯ä»¥å›é€€åˆ° HTTP è½®è¯¢
- **HTTP è¶…æ—¶æ—¶**ï¼šå¯ä»¥ä¾èµ– WebSocket æ¨é€

### 3. **çµæ´»æ€§**

```swift
// åœºæ™¯ 1ï¼šç”¨æˆ·ä¸»åŠ¨åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨
// â†’ ä½¿ç”¨ HTTP Pull
client.syncMessages()

// åœºæ™¯ 2ï¼šæœ‰äººç»™ä½ å‘æ¶ˆæ¯
// â†’ æœåŠ¡å™¨é€šè¿‡ WebSocket Push
// â†’ è§¦å‘ handleWebSocketSyncResponse()
```

---

## ğŸ¨ å®é™…åº”ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šæ–­çº¿é‡è¿ï¼ˆä½¿ç”¨ HTTPï¼‰

```
ç”¨æˆ·æ‰‹æœºæ–­ç½‘ 30 åˆ†é’Ÿ
        â†“
é‡æ–°è¿æ¥ WiFi
        â†“
IMClient æ£€æµ‹åˆ°é‡è¿
        â†“
è°ƒç”¨ syncOfflineMessagesAfterReconnect()
        â†“
é€šè¿‡ HTTP ä¸»åŠ¨æ‹‰å–ç¦»çº¿æ¶ˆæ¯ï¼ˆ30 åˆ†é’Ÿå†…çš„æ¶ˆæ¯ï¼‰
        â†“
æ‰¹é‡ä¿å­˜åˆ°æ•°æ®åº“
        â†“
ç”¨æˆ·çœ‹åˆ° 50 æ¡æœªè¯»æ¶ˆæ¯ âœ…
```

### åœºæ™¯ 2ï¼šåœ¨çº¿èŠå¤©ï¼ˆä½¿ç”¨ WebSocketï¼‰

```
ä½ æ­£åœ¨å’Œæœ‹å‹èŠå¤©
        â†“
æœ‹å‹å‘é€ï¼š"æ™šä¸Šåƒä»€ä¹ˆï¼Ÿ"
        â†“
æœåŠ¡å™¨é€šè¿‡ WebSocket æ¨é€ç»™ä½ 
        â†“
è§¦å‘ handleWebSocketSyncResponse()
        â†“
è§£æå¹¶ä¿å­˜æ¶ˆæ¯
        â†“
UI ç«‹å³æ˜¾ç¤ºæ–°æ¶ˆæ¯ âœ…ï¼ˆå®æ—¶æ€§ < 100msï¼‰
```

### åœºæ™¯ 3ï¼šæ··åˆä½¿ç”¨

```
ä½ æ­£åœ¨èŠå¤©ï¼ˆWebSocket æ­£å¸¸å·¥ä½œï¼‰
        â†“
çªç„¶ç½‘ç»œæŠ–åŠ¨ï¼ŒWebSocket çŸ­æš‚æ–­å¼€
        â†“
5 ç§’å WebSocket é‡è¿æˆåŠŸ
        â†“
è°ƒç”¨ syncOfflineMessagesAfterReconnect()
        â†“
é€šè¿‡ HTTP æ‹‰å–è¿™ 5 ç§’å†…å¯èƒ½æ¼æ‰çš„æ¶ˆæ¯
        â†“
ä¸¤ç§æœºåˆ¶äº’è¡¥ï¼Œç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤± âœ…
```

---

## ğŸ”§ ä»£ç è¿½è¸ª

### HTTP Pull æµç¨‹

```swift
// 1. è§¦å‘å…¥å£
IMClient.syncOfflineMessagesAfterReconnect()
    â†“
// 2. è°ƒç”¨åŒæ­¥ç®¡ç†å™¨
messageSyncManager.sync(fromSeq: localMaxSeq + 1)
    â†“
// 3. æ‰§è¡Œå¢é‡åŒæ­¥
IMMessageSyncManager.performIncrementalSync(fromSeq:)
    â†“
// 4. åˆ†æ‰¹æ‹‰å–
IMMessageSyncManager.syncBatch(lastSeq:)
    â†“
// 5. å‘èµ· HTTP è¯·æ±‚ âš ï¸ å…³é”®
httpManager.syncMessages(lastSeq: lastSeq, count: batchSize)
    â†“
// 6. å¤„ç† HTTP å“åº”
handleSyncSuccess(response:)
    â†“
// 7. ä¿å­˜åˆ°æ•°æ®åº“
batchSaveMessages(messages)
```

### WebSocket Push æµç¨‹

```swift
// 1. æœåŠ¡å™¨æ¨é€æ¶ˆæ¯
Server â†’ WebSocket â†’ IMClient
    â†“
// 2. æ¥æ”¶æ•°æ®
IMClient.handleTransportReceive(data)
    â†“
// 3. è·¯ç”±æ¶ˆæ¯
IMClient.routeWebSocketMessage(data)
    â†“
// 4. å¤„ç†åŒæ­¥å“åº” âš ï¸ å…³é”®
IMClient.handleWebSocketSyncResponse(body, sequence)
    â†“
// 5. è§£æ Protobuf
Im_Protocol_SyncResponse(serializedData: body)
    â†“
// 6. è½¬æ¢æ¶ˆæ¯æ ¼å¼
Protobuf â†’ IMMessage
    â†“
// 7. ä¼ é€’ç»™åŒæ­¥ç®¡ç†å™¨
messageSyncManager.handleSyncResponse(messages, serverMaxSeq, hasMore)
```

---

## ğŸš€ ç±»æ¯”ç†è§£

### HTTP Pull = ä½ ä¸»åŠ¨å»å–å¿«é€’

```
ä½ ï¼š  "è€æ¿ï¼Œæˆ‘æœ‰å¿«é€’å—ï¼Ÿ"              â† HTTP è¯·æ±‚
è€æ¿ï¼š"æœ‰çš„ï¼Œè¿™æ˜¯ä½ çš„ 3 ä¸ªåŒ…è£¹"         â† HTTP å“åº”
ä½ ï¼š  ï¼ˆæ‹¿èµ°åŒ…è£¹ï¼‰                       â† å¤„ç†æ¶ˆæ¯
```

**ç‰¹ç‚¹ï¼š**
- ä½ ä¸»åŠ¨å»é—®
- å¯èƒ½ç™½è·‘ä¸€è¶Ÿï¼ˆæ²¡æœ‰æ–°å¿«é€’ï¼‰
- å¯ä»¥æ‰¹é‡å–ï¼ˆä¸€æ¬¡å–å¤šä¸ªï¼‰

### WebSocket Push = å¿«é€’å‘˜é€è´§ä¸Šé—¨

```
å¿«é€’å‘˜ï¼š"å…ˆç”Ÿï¼Œä½ æœ‰å¿«é€’ï¼"              â† WebSocket æ¨é€
ä½ ï¼š    ï¼ˆå¼€é—¨ç­¾æ”¶ï¼‰                     â† å¤„ç†æ¶ˆæ¯
```

**ç‰¹ç‚¹ï¼š**
- å¿«é€’å‘˜ä¸»åŠ¨é€ä¸Šé—¨
- å®æ—¶æ€§é«˜ï¼ˆåˆ°äº†ç«‹å³é€ï¼‰
- éœ€è¦ä¿æŒè”ç³»ï¼ˆå¿«é€’å‘˜èƒ½æ‰¾åˆ°ä½ ï¼‰

---

## âœ… æ€»ç»“

### å…³é”®åŒºåˆ«

1. **åè®®ä¸åŒ**ï¼šHTTP vs WebSocket
2. **æ–¹å‘ä¸åŒ**ï¼šPull vs Push
3. **è§¦å‘ä¸åŒ**ï¼šå®¢æˆ·ç«¯ä¸»åŠ¨ vs æœåŠ¡å™¨ä¸»åŠ¨
4. **åœºæ™¯ä¸åŒ**ï¼šç¦»çº¿æ¶ˆæ¯ vs å®æ—¶æ¶ˆæ¯

### ä¸ºä»€ä¹ˆå…±å­˜ï¼Ÿ

- **HTTP Pull**ï¼šå¯é ã€å¯æ§ã€é€‚åˆæ‰¹é‡
- **WebSocket Push**ï¼šå®æ—¶ã€é«˜æ•ˆã€é€‚åˆå³æ—¶

**ä¸¤è€…äº’è¡¥ï¼Œç¡®ä¿æ¶ˆæ¯åŒæ­¥çš„å¯é æ€§å’Œå®æ—¶æ€§ï¼**

---

## ğŸ™ æ„Ÿè°¢ç”¨æˆ·æŒ‡æ­£

**éå¸¸æ„Ÿè°¢ä½ çš„ç»†å¿ƒå‘ç°ï¼**

æˆ‘ä¹‹å‰é”™è¯¯åœ°è®¤ä¸ºå®ƒä»¬æ˜¯ä¸€ä¸ªæµç¨‹çš„ä¸¤ä¸ªæ­¥éª¤ï¼ˆè¯·æ±‚-å“åº”ï¼‰ï¼Œå®é™…ä¸Šå®ƒä»¬æ˜¯**ä¸¤ç§å®Œå…¨ç‹¬ç«‹çš„åŒæ­¥æœºåˆ¶**ã€‚

**è¿™æ˜¯ä¸€ä¸ªç»å…¸çš„æ··åˆæ¶æ„è®¾è®¡ï¼š**
- ç»“åˆ HTTP çš„å¯é æ€§
- ç»“åˆ WebSocket çš„å®æ—¶æ€§
- è¾¾åˆ°æœ€ä½³ç”¨æˆ·ä½“éªŒ

å†æ¬¡æ„Ÿè°¢ä½ çš„æŒ‡æ­£ï¼Œè®©æˆ‘èƒ½å¤Ÿæ›´å‡†ç¡®åœ°ç†è§£å’Œè§£é‡Šè¿™ä¸ªè®¾è®¡ï¼ğŸ™

