# ç¼–è¯‘é”™è¯¯ä¿®å¤æ€»ç»“

## ğŸ› é—®é¢˜ 1: `Cannot find 'userID' in scope`

### é”™è¯¯ä»£ç 
```swift
guard message.senderID == userID else {
    return .failure(.permissionDenied)
}
```

### åŸå› 
`IMMessageManager` ä¸­æ²¡æœ‰ `userID` å±æ€§ï¼Œè¿™ä¸ªå˜é‡ä¸å­˜åœ¨ã€‚

### ä¿®å¤æ–¹æ¡ˆ
ä½¿ç”¨ `getCurrentUserID()` æ–¹æ³•è·å–å½“å‰ç”¨æˆ· IDï¼š

```swift
guard message.senderID == getCurrentUserID() else {
    return .failure(.permissionDenied)
}
```

---

## ğŸ› é—®é¢˜ 2: åè®®æ–¹æ³•ç­¾åä¸åŒ¹é…

### é”™è¯¯ä»£ç 

**åè®®å®šä¹‰ï¼š**
```swift
func onMessageRevoked(_ messageID: String)  // âŒ å‚æ•°ç±»å‹ä¸åŒ¹é…
```

**è°ƒç”¨ä»£ç ï¼š**
```swift
listener.onMessageRevoked(message: message)  // ä¼ é€’çš„æ˜¯ IMMessage
```

### åŸå› 
åè®®å®šä¹‰æ¥å—çš„æ˜¯ `String` ç±»å‹çš„ `messageID`ï¼Œä½†è°ƒç”¨æ—¶ä¼ é€’çš„æ˜¯ `IMMessage` å¯¹è±¡ã€‚

### ä¿®å¤æ–¹æ¡ˆ

#### 1. ä¿®æ”¹åè®®å®šä¹‰

```swift
public protocol IMMessageListener: AnyObject {
    /// æ¶ˆæ¯è¢«æ’¤å›
    /// - Parameter message: è¢«æ’¤å›çš„æ¶ˆæ¯ï¼ˆå·²æ›´æ–°ä¸ºæ’¤å›çŠ¶æ€ï¼‰
    func onMessageRevoked(message: IMMessage)
}

// æä¾›é»˜è®¤å®ç°
public extension IMMessageListener {
    func onMessageRevoked(message: IMMessage) {}
}
```

**ä¸ºä»€ä¹ˆä¼ é€’ `IMMessage` æ›´å¥½ï¼Ÿ**
- âœ… UI å±‚å¯ä»¥è®¿é—®å®Œæ•´çš„æ¶ˆæ¯ä¿¡æ¯ï¼ˆå‘é€è€…ã€æ—¶é—´ç­‰ï¼‰
- âœ… å¯ä»¥åŒºåˆ†"ä½ æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯"è¿˜æ˜¯"å¯¹æ–¹æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯"
- âœ… æ›´çµæ´»ï¼Œä¾¿äº UI å±•ç¤º

---

## ğŸ› é—®é¢˜ 3: é‡å¤çš„ç›‘å¬å™¨å®šä¹‰

### é”™è¯¯ä»£ç 

```swift
// IMMessageManager+P0Features.swift
extension IMMessageListener {
    @objc optional func onMessageRevoked(message: IMMessage)  // âŒ é‡å¤å®šä¹‰
}
```

### åŸå› 
åœ¨ `IMMessageManager.swift` ä¸­å·²ç»å®šä¹‰äº†å®Œæ•´çš„åè®®ï¼Œä¸éœ€è¦åœ¨æ‰©å±•æ–‡ä»¶ä¸­é‡å¤å®šä¹‰ã€‚

### ä¿®å¤æ–¹æ¡ˆ
åˆ é™¤é‡å¤çš„å®šä¹‰ï¼Œæ·»åŠ æ³¨é‡Šè¯´æ˜ï¼š

```swift
// MARK: - ç›‘å¬å™¨æ‰©å±•
// æ³¨æ„ï¼šç›‘å¬å™¨æ–¹æ³•å·²åœ¨ IMMessageListener åè®®ä¸­å®šä¹‰ï¼Œå¹¶æä¾›äº†é»˜è®¤ç©ºå®ç°
```

---

## âœ… ä¿®å¤åçš„å®Œæ•´ä»£ç 

### IMMessageManager.swift

```swift
/// æ¶ˆæ¯ç›‘å¬å™¨
public protocol IMMessageListener: AnyObject {
    /// æ”¶åˆ°æ–°æ¶ˆæ¯
    func onMessageReceived(_ message: IMMessage)
    
    /// æ¶ˆæ¯çŠ¶æ€æ”¹å˜
    func onMessageStatusChanged(_ message: IMMessage)
    
    /// æ¶ˆæ¯è¢«æ’¤å›
    /// - Parameter message: è¢«æ’¤å›çš„æ¶ˆæ¯ï¼ˆå·²æ›´æ–°ä¸ºæ’¤å›çŠ¶æ€ï¼‰
    func onMessageRevoked(message: IMMessage)
    
    /// æ¶ˆæ¯å·²è¯»å›æ‰§
    func onMessageReadReceiptReceived(conversationID: String, messageIDs: [String])
}

// æä¾›é»˜è®¤å®ç°ï¼Œä½¿æ‰€æœ‰æ–¹æ³•å¯é€‰
public extension IMMessageListener {
    func onMessageReceived(_ message: IMMessage) {}
    func onMessageStatusChanged(_ message: IMMessage) {}
    func onMessageRevoked(message: IMMessage) {}
    func onMessageReadReceiptReceived(conversationID: String, messageIDs: [String]) {}
}
```

### IMMessageManager+P0Features.swift

```swift
/// æ’¤å›æ¶ˆæ¯ï¼ˆåŒæ­¥æ–¹æ³•ï¼‰
@discardableResult
public func revokeMessage(messageID: String) -> Result<Void, IMError> {
    // 1. ä»æ•°æ®åº“è·å–æ¶ˆæ¯
    guard let message = database.getMessage(messageID: messageID) else {
        return .failure(.messageNotFound)
    }
    
    // 2. æ£€æŸ¥æ˜¯å¦æ˜¯å‘é€è€…
    guard message.senderID == getCurrentUserID() else {
        return .failure(.permissionDenied)
    }
    
    // 3. æ£€æŸ¥æ—¶é—´é™åˆ¶
    // ...
    
    // 4. å‘é€è¯·æ±‚
    return sendRevokeRequest(messageID: messageID, conversationID: message.conversationID)
}

/// å¤„ç†æ’¤å›æ¶ˆæ¯é€šçŸ¥
internal func handleRevokeNotification(messageID: String, revokerID: String, revokeTime: Int64) {
    // 1. æ›´æ–°æ•°æ®åº“
    updateMessageAsRevoked(messageID: messageID, revokerID: revokerID, revokeTime: revokeTime)
    
    // 2. è·å–æ¶ˆæ¯
    guard let message = database.getMessage(messageID: messageID) else { return }
    
    // 3. é€šçŸ¥ç›‘å¬å™¨
    notifyListeners { listener in
        listener.onMessageRevoked(message: message)  // âœ… ä¼ é€’å®Œæ•´çš„æ¶ˆæ¯å¯¹è±¡
    }
    
    // 4. æ›´æ–°ä¼šè¯
    updateConversationIfNeeded(message: message)
}
```

---

## ğŸ“Š UI å±‚ä½¿ç”¨ç¤ºä¾‹

### å®ç°ç›‘å¬å™¨

```swift
class ChatViewController: UIViewController, IMMessageListener {
    
    // âœ… å®ç° onMessageRevoked æ–¹æ³•
    func onMessageRevoked(message: IMMessage) {
        // å¯ä»¥è®¿é—®å®Œæ•´çš„æ¶ˆæ¯ä¿¡æ¯
        let isMine = message.senderID == getCurrentUserID()
        
        if isMine {
            // æˆ‘æ’¤å›çš„æ¶ˆæ¯
            updateMessageCell(messageID: message.messageID, text: "ä½ æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯")
        } else {
            // å¯¹æ–¹æ’¤å›çš„æ¶ˆæ¯
            let senderName = getSenderName(message.senderID)
            updateMessageCell(messageID: message.messageID, text: "\(senderName) æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯")
        }
        
        // æ’­æ”¾åŠ¨ç”»
        animateMessageRevoke(messageID: message.messageID)
    }
    
    func onMessageReceived(_ message: IMMessage) {
        // æ”¶åˆ°æ–°æ¶ˆæ¯
    }
    
    func onMessageStatusChanged(_ message: IMMessage) {
        // æ¶ˆæ¯çŠ¶æ€æ”¹å˜
    }
    
    func onMessageReadReceiptReceived(conversationID: String, messageIDs: [String]) {
        // å·²è¯»å›æ‰§
    }
}
```

### å‘èµ·æ’¤å›

```swift
func onRevokeButtonTapped(messageID: String) {
    // åŒæ­¥æ–¹æ³•ï¼Œç«‹å³è¿”å›ç»“æœ
    let result = IMClient.shared.messageManager?.revokeMessage(messageID: messageID)
    
    switch result {
    case .success:
        print("æ’¤å›è¯·æ±‚å·²å‘é€")
        // âš ï¸ ä¸è¦åœ¨è¿™é‡Œæ›´æ–° UI
        // UI æ›´æ–°åœ¨ onMessageRevoked å›è°ƒä¸­å¤„ç†
        
    case .failure(let error):
        showError("æ’¤å›å¤±è´¥: \(error)")
        
    case .none:
        showError("æ¶ˆæ¯ç®¡ç†å™¨æœªåˆå§‹åŒ–")
    }
}
```

---

## ğŸ¯ æ€»ç»“

### ä¿®å¤æ¸…å•

- âœ… ä¿®å¤ `userID` ä½œç”¨åŸŸé—®é¢˜ â†’ ä½¿ç”¨ `getCurrentUserID()`
- âœ… ä¿®æ”¹åè®®æ–¹æ³•ç­¾å â†’ `onMessageRevoked(message: IMMessage)`
- âœ… åˆ é™¤é‡å¤çš„ç›‘å¬å™¨å®šä¹‰
- âœ… æä¾›é»˜è®¤ç©ºå®ç°ï¼Œä½¿æ‰€æœ‰æ–¹æ³•å¯é€‰

### å…³é”®æ”¹è¿›

1. **æ›´å¥½çš„ API è®¾è®¡**
   - ä¼ é€’å®Œæ•´çš„ `IMMessage` å¯¹è±¡
   - UI å±‚å¯ä»¥è®¿é—®æ›´å¤šä¿¡æ¯

2. **ä»£ç ä¸€è‡´æ€§**
   - ä¸å…¶ä»–ç›‘å¬å™¨æ–¹æ³•ä¿æŒä¸€è‡´ï¼ˆéƒ½ä¼ é€’å¯¹è±¡è€Œé IDï¼‰
   - æ˜“äºç†è§£å’Œä½¿ç”¨

3. **çµæ´»æ€§**
   - UI å±‚å¯ä»¥æ ¹æ®æ¶ˆæ¯ä¿¡æ¯åšå·®å¼‚åŒ–å±•ç¤º
   - ä¾¿äºåç»­æ‰©å±•

---

## ğŸ’¡ æœ€ä½³å®è·µ

### ç›‘å¬å™¨æ–¹æ³•è®¾è®¡åŸåˆ™

1. **ä¼ é€’å®Œæ•´å¯¹è±¡ > åªä¼  ID**
   ```swift
   // âœ… æ¨èï¼šä¼ é€’å®Œæ•´å¯¹è±¡
   func onMessageRevoked(message: IMMessage)
   
   // âŒ ä¸æ¨èï¼šåªä¼  IDï¼ˆä¿¡æ¯ä¸è¶³ï¼‰
   func onMessageRevoked(_ messageID: String)
   ```

2. **æä¾›é»˜è®¤å®ç°**
   ```swift
   public extension IMMessageListener {
       func onMessageRevoked(message: IMMessage) {}  // é»˜è®¤ç©ºå®ç°
   }
   ```

3. **æ¸…æ™°çš„æ–‡æ¡£æ³¨é‡Š**
   ```swift
   /// æ¶ˆæ¯è¢«æ’¤å›
   /// - Parameter message: è¢«æ’¤å›çš„æ¶ˆæ¯ï¼ˆå·²æ›´æ–°ä¸ºæ’¤å›çŠ¶æ€ï¼‰
   func onMessageRevoked(message: IMMessage)
   ```

**ç¼–è¯‘é”™è¯¯å·²å…¨éƒ¨ä¿®å¤ï¼** âœ¨

