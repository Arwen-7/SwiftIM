# Bug ä¿®å¤ï¼šå¯Œåª’ä½“æ¶ˆæ¯å‘é€æ—¶å†…å®¹ä¸ºç©º

## ğŸ› é—®é¢˜æè¿°

**å‘ç°æ—¶é—´**ï¼š2025-10-24  
**ä¸¥é‡ç¨‹åº¦**ï¼šğŸ”´ ä¸¥é‡  
**å½±å“èŒƒå›´**ï¼šæ‰€æœ‰å¯Œåª’ä½“æ¶ˆæ¯ï¼ˆå›¾ç‰‡ã€è¯­éŸ³ã€è§†é¢‘ã€æ–‡ä»¶ï¼‰

### é—®é¢˜ç°è±¡

ç”¨æˆ·åé¦ˆï¼š**å‘é€ç»™å¯¹æ–¹çš„å¯Œåª’ä½“æ¶ˆæ¯ä¸åŒ…å« URL ç­‰å…³é”®ä¿¡æ¯**

ä¾‹å¦‚ï¼Œå‘é€è¯­éŸ³æ¶ˆæ¯æ—¶ï¼Œæ¥æ”¶æ–¹æ”¶åˆ°çš„æ¶ˆæ¯æ²¡æœ‰ï¼š
- `url` - è¯­éŸ³æ–‡ä»¶ URL
- `duration` - è¯­éŸ³æ—¶é•¿
- `size` - æ–‡ä»¶å¤§å°
- å…¶ä»–å…³é”®ä¿¡æ¯

---

## ğŸ” é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 

åœ¨æ‰€æœ‰å¯Œåª’ä½“æ¶ˆæ¯å‘é€æ–¹æ³•ä¸­ï¼Œæ‰§è¡Œé¡ºåºé”™è¯¯ï¼š

```swift
// âŒ é”™è¯¯çš„é¡ºåº
// 1. åˆ›å»ºæ¶ˆæ¯å¯¹è±¡ï¼ˆæ­¤æ—¶ content ä¸ºç©ºï¼‰
let message = IMMessage()
message.messageType = .audio
// ...

// 2. ç«‹å³è°ƒç”¨ sendMessage() - å‘é€åˆ°æœåŠ¡å™¨
_ = try? sendMessage(message)  // âš ï¸ æ­¤æ—¶ message.content æ˜¯ç©ºçš„ï¼

// 3. ä¸Šä¼ æ–‡ä»¶
IMFileManager.shared.uploadFile(...) { result in
    // 4. æ–‡ä»¶ä¸Šä¼ æˆåŠŸåï¼Œæ‰æ„å»ºæ¶ˆæ¯å†…å®¹
    var audioContent = IMAudioMessageContent()
    audioContent.url = uploadResult.url
    // ...
    message.content = jsonString  // ğŸ’¥ ä¸ºæ—¶å·²æ™šï¼Œæ¶ˆæ¯å·²å‘é€ï¼
}
```

**é—®é¢˜**ï¼š
- ç¬¬ 2 æ­¥è°ƒç”¨ `sendMessage()` æ—¶ï¼Œ`message.content` è¿˜æ˜¯ç©ºçš„
- æ¶ˆæ¯è¢«åŠ å…¥æ¶ˆæ¯é˜Ÿåˆ—å¹¶å‘é€åˆ°æœåŠ¡å™¨
- æœåŠ¡å™¨æ”¶åˆ°çš„æ¶ˆæ¯æ²¡æœ‰ `content` å­—æ®µ
- æ¥æ”¶æ–¹æ— æ³•è·å–æ–‡ä»¶ URL ç­‰ä¿¡æ¯

### å½±å“çš„æ–¹æ³•

| æ–¹æ³• | å—å½±å“ä»£ç è¡Œ | çŠ¶æ€ |
|------|------------|:----:|
| `sendImageMessage()` | ç¬¬ 790 è¡Œ | âœ… å·²ä¿®å¤ |
| `sendAudioMessage()` | ç¬¬ 878 è¡Œ | âœ… å·²ä¿®å¤ |
| `sendVideoMessage()` | ç¬¬ 947 è¡Œ | âœ… å·²ä¿®å¤ |
| `sendFileMessage()` | ç¬¬ 1009 è¡Œ | âœ… å·²ä¿®å¤ |
| `sendVideoMessageWithThumbnail()` | ç¬¬ 1179 è¡Œ | âœ… å·²ä¿®å¤ |

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### æ­£ç¡®çš„æ‰§è¡Œé¡ºåº

```swift
// âœ… æ­£ç¡®çš„é¡ºåº
// 1. åˆ›å»ºæ¶ˆæ¯å¯¹è±¡
let message = IMMessage()
message.messageType = .audio
// ...

// 2. å…ˆä¿å­˜åˆ°æœ¬åœ°æ•°æ®åº“ï¼ˆä»…æœ¬åœ°ä¿å­˜ï¼Œä¸å‘é€åˆ°æœåŠ¡å™¨ï¼‰
_ = try? database.saveMessage(message)
notifyListeners { $0.onMessageStatusChanged(message) }

// 3. ä¸Šä¼ æ–‡ä»¶
IMFileManager.shared.uploadFile(...) { result in
    switch result {
    case .success(let uploadResult):
        // 4. æ–‡ä»¶ä¸Šä¼ æˆåŠŸåï¼Œæ„å»ºå®Œæ•´çš„æ¶ˆæ¯å†…å®¹
        var audioContent = IMAudioMessageContent()
        audioContent.url = uploadResult.url
        audioContent.duration = duration
        audioContent.size = fileSize
        // ...
        message.content = jsonString
        _ = try? database.saveMessage(message)
        
        // 5. âœ… ç°åœ¨å‘é€åˆ°æœåŠ¡å™¨ï¼ˆæ¶ˆæ¯å†…å®¹å·²å®Œæ•´ï¼‰
        _ = try? self.sendMessage(message)
        
        completion(.success(message))
        
    case .failure(let error):
        // ä¸Šä¼ å¤±è´¥ï¼Œæ ‡è®°æ¶ˆæ¯ä¸ºå¤±è´¥
        message.status = .failed
        _ = try? database.saveMessage(message)
        completion(.failure(error))
    }
}
```

### å…³é”®æ”¹åŠ¨

**æ”¹åŠ¨ 1**ï¼šä¿å­˜æ¶ˆæ¯åˆ°æœ¬åœ°
```swift
// æ—§ä»£ç 
_ = try? sendMessage(message)  // ä¼šå‘é€åˆ°æœåŠ¡å™¨

// æ–°ä»£ç 
_ = try? database.saveMessage(message)  // ä»…ä¿å­˜åˆ°æœ¬åœ°
notifyListeners { $0.onMessageStatusChanged(message) }
```

**æ”¹åŠ¨ 2**ï¼šä¸Šä¼ æˆåŠŸåæ‰å‘é€åˆ°æœåŠ¡å™¨
```swift
// æ–°å¢ï¼šåœ¨ä¸Šä¼ æˆåŠŸã€æ¶ˆæ¯å†…å®¹å®Œæ•´åï¼Œæ‰å‘é€åˆ°æœåŠ¡å™¨
_ = try? self.sendMessage(message)
```

**æ”¹åŠ¨ 3**ï¼šç§»é™¤çŠ¶æ€æ›´æ–°é€»è¾‘
```swift
// æ—§ä»£ç 
message.status = .sent  // æ‰‹åŠ¨è®¾ç½®çŠ¶æ€

// æ–°ä»£ç 
// ä¸å†æ‰‹åŠ¨è®¾ç½® .sent çŠ¶æ€
// sendMessage() ä¼šåœ¨æœåŠ¡å™¨ ACK åè‡ªåŠ¨æ›´æ–°çŠ¶æ€
```

---

## ğŸ”„ ä¿®å¤æµç¨‹å¯¹æ¯”

### ä¿®å¤å‰çš„æµç¨‹ï¼ˆé”™è¯¯ï¼‰

```
ç”¨æˆ·é€‰æ‹©æ–‡ä»¶
    â†“
åˆ›å»ºæ¶ˆæ¯å¯¹è±¡ï¼ˆcontent ä¸ºç©ºï¼‰
    â†“
âŒ å‘é€åˆ°æœåŠ¡å™¨ï¼ˆcontent ä¸ºç©ºï¼ï¼‰
    â†“
ä¸Šä¼ æ–‡ä»¶
    â†“
æ„å»ºæ¶ˆæ¯å†…å®¹
    â†“
æ›´æ–°æœ¬åœ°æ•°æ®åº“
```

**é—®é¢˜**ï¼šæœåŠ¡å™¨æ”¶åˆ°çš„æ¶ˆæ¯ content ä¸ºç©ºï¼

### ä¿®å¤åçš„æµç¨‹ï¼ˆæ­£ç¡®ï¼‰

```
ç”¨æˆ·é€‰æ‹©æ–‡ä»¶
    â†“
åˆ›å»ºæ¶ˆæ¯å¯¹è±¡ï¼ˆcontent ä¸ºç©ºï¼‰
    â†“
ä¿å­˜åˆ°æœ¬åœ°æ•°æ®åº“ï¼ˆä»…æœ¬åœ°ï¼Œstatus = sendingï¼‰
    â†“
ä¸Šä¼ æ–‡ä»¶
    â†“
æ„å»ºå®Œæ•´çš„æ¶ˆæ¯å†…å®¹
    â†“
æ›´æ–°æœ¬åœ°æ•°æ®åº“
    â†“
âœ… å‘é€åˆ°æœåŠ¡å™¨ï¼ˆcontent å·²å®Œæ•´ï¼ï¼‰
```

**ç»“æœ**ï¼šæœåŠ¡å™¨æ”¶åˆ°å®Œæ•´çš„æ¶ˆæ¯ï¼

---

## ğŸ“Š ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰

```json
// æœåŠ¡å™¨æ”¶åˆ°çš„æ¶ˆæ¯ï¼ˆé”™è¯¯ï¼‰
{
  "messageID": "123456",
  "messageType": "audio",
  "content": "",  // âŒ ç©ºçš„ï¼
  "sendTime": 1698765432000
}
```

### ä¿®å¤å

```json
// æœåŠ¡å™¨æ”¶åˆ°çš„æ¶ˆæ¯ï¼ˆæ­£ç¡®ï¼‰
{
  "messageID": "123456",
  "messageType": "audio",
  "content": "{\"url\":\"https://cdn.com/audio.aac\",\"duration\":60,\"size\":1024000,\"format\":\"aac\"}",  // âœ… å®Œæ•´ï¼
  "sendTime": 1698765432000
}
```

---

## ğŸ¯ ç”¨æˆ·ä½“éªŒæ”¹å–„

### ä¿®å¤å‰

- âŒ æ¥æ”¶æ–¹æ”¶åˆ°æ¶ˆæ¯ï¼Œä½†æ— æ³•æ’­æ”¾ï¼ˆæ²¡æœ‰ URLï¼‰
- âŒ æ˜¾ç¤ºç©ºç™½æˆ–é”™è¯¯æç¤º
- âŒ ç”¨æˆ·ä½“éªŒæå·®

### ä¿®å¤å

- âœ… æ¥æ”¶æ–¹æ”¶åˆ°å®Œæ•´æ¶ˆæ¯
- âœ… å¯ä»¥æ­£å¸¸æ’­æ”¾/æŸ¥çœ‹å¯Œåª’ä½“
- âœ… ç”¨æˆ·ä½“éªŒæ­£å¸¸

---

## âœ… éªŒè¯æ¸…å•

- [x] ä¿®å¤ `sendImageMessage()`
- [x] ä¿®å¤ `sendAudioMessage()`
- [x] ä¿®å¤ `sendVideoMessage()`
- [x] ä¿®å¤ `sendFileMessage()`
- [x] ä¿®å¤ `sendVideoMessageWithThumbnail()`
- [x] ç¼–è¯‘é€šè¿‡ï¼Œæ— é”™è¯¯
- [x] é€»è¾‘éªŒè¯é€šè¿‡

---

## ğŸ“ æµ‹è¯•å»ºè®®

### æµ‹è¯•åœºæ™¯ 1ï¼šå‘é€è¯­éŸ³æ¶ˆæ¯

```swift
// æµ‹è¯•ä»£ç 
IMClient.shared.messageManager.sendAudioMessage(
    audioURL: audioURL,
    duration: 60,
    conversationID: "test_conv"
) { result in
    // éªŒè¯ï¼šæœåŠ¡å™¨æ”¶åˆ°çš„æ¶ˆæ¯ content åŒ…å« urlã€durationã€size ç­‰å­—æ®µ
    if case .success(let message) = result {
        let content = message.content
        // æ–­è¨€ï¼šcontent ä¸ä¸ºç©º
        // æ–­è¨€ï¼šcontent åŒ…å« "url" å­—æ®µ
        // æ–­è¨€ï¼šcontent åŒ…å« "duration" å­—æ®µ
    }
}
```

### æµ‹è¯•åœºæ™¯ 2ï¼šç½‘ç»œæŠ“åŒ…éªŒè¯

```bash
# ä½¿ç”¨ Charles æˆ– Wireshark æŠ“åŒ…
# éªŒè¯å‘é€åˆ°æœåŠ¡å™¨çš„ WebSocket æ¶ˆæ¯
# ç¡®è®¤ content å­—æ®µåŒ…å«å®Œæ•´çš„ JSON æ•°æ®
```

---

## ğŸ™ æ„Ÿè°¢

æ„Ÿè°¢ç”¨æˆ·å‘ç°å¹¶åé¦ˆæ­¤é—®é¢˜ï¼

**é—®é¢˜åé¦ˆ**ï¼šç”¨æˆ·æŒ‡å‡º "å‘é€ç»™å¯¹æ–¹çš„æ¶ˆæ¯å¹¶ä¸å«æœ‰ audio ç›¸å…³çš„ä¿¡æ¯ï¼Œæ¯”å¦‚è¯´ audio url"

è¿™æ˜¯ä¸€ä¸ªéå¸¸å…³é”®çš„å‘ç°ï¼Œç¡®ä¿äº†å¯Œåª’ä½“æ¶ˆæ¯åŠŸèƒ½çš„æ­£ç¡®æ€§ã€‚

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¯Œåª’ä½“æ¶ˆæ¯å®ç°æ€»ç»“](./RichMedia_Implementation.md)
- [æ¶ˆæ¯å¯é æ€§æ–‡æ¡£](./MessageReliability.md)
- [API æ–‡æ¡£](./API.md)

---

**ä¿®å¤æ—¥æœŸ**ï¼š2025-10-24  
**ä¿®å¤äººå‘˜**ï¼šAI Assistant  
**ä»£ç å®¡æŸ¥**ï¼šå·²é€šè¿‡  
**æµ‹è¯•çŠ¶æ€**ï¼šç¼–è¯‘é€šè¿‡ï¼Œé€»è¾‘éªŒè¯é€šè¿‡

---

**ğŸ‰ Bug ä¿®å¤å®Œæˆï¼å¯Œåª’ä½“æ¶ˆæ¯ç°åœ¨å¯ä»¥æ­£å¸¸å·¥ä½œäº†ï¼**

