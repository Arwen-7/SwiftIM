# IM iOS SDK 架构图（视觉化）

## 🎨 完整架构图

```
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃                           📱 Application Layer                        ┃
┃                          (iOS 应用 - UIKit/SwiftUI)                  ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
                                     ⬇️ ⬆️
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃                             🚪 API Layer                              ┃
┃ ┌─────────────────────────────────────────────────────────────────┐ ┃
┃ │                         IMClient (单例)                          │ ┃
┃ │  • initialize()        • login()           • logout()           │ ┃
┃ │  • messageManager      • conversationManager                     │ ┃
┃ │  • groupManager        • friendManager                           │ ┃
┃ └─────────────────────────────────────────────────────────────────┘ ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
                                     ⬇️ ⬆️
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃                          💼 Business Layer                            ┃
┃                                                                        ┃
┃  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     ┃
┃  │   💬 Message    │  │   📋 Conversation│  │    👤 User      │     ┃
┃  │    Manager      │  │     Manager     │  │    Manager      │     ┃
┃  │                 │  │                 │  │                 │     ┃
┃  │ • send()        │  │ • getAll()      │  │ • getUserInfo() │     ┃
┃  │ • receive()     │  │ • unreadCount() │  │ • update()      │     ┃
┃  │ • revoke()      │  │ • markRead()    │  │ • search()      │     ┃
┃  │ • search()      │  │ • pin()         │  └─────────────────┘     ┃
┃  └─────────────────┘  └─────────────────┘                           ┃
┃                                                                        ┃
┃  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     ┃
┃  │   👥 Group      │  │   ✅ Friend     │  │   📂 File       │     ┃
┃  │    Manager      │  │    Manager      │  │    Manager      │     ┃
┃  │                 │  │                 │  │                 │     ┃
┃  │ • create()      │  │ • add()         │  │ • upload()      │     ┃
┃  │ • addMember()   │  │ • delete()      │  │ • download()    │     ┃
┃  │ • update()      │  │ • getList()     │  │ • compress()    │     ┃
┃  └─────────────────┘  └─────────────────┘  └─────────────────┘     ┃
┃                                                                        ┃
┃  ┌─────────────────┐  ┌─────────────────┐                           ┃
┃  │   ⌨️ Typing      │  │   🔄 MessageSync│                           ┃
┃  │    Manager      │  │     Manager     │                           ┃
┃  │                 │  │                 │                           ┃
┃  │ • sendStatus()  │  │ • syncIncremental()                        ┃
┃  │ • receive()     │  │ • syncBatch()   │                           ┃
┃  └─────────────────┘  └─────────────────┘                           ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
                                     ⬇️ ⬆️
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃                            ⚙️ Core Layer                              ┃
┃                                                                        ┃
┃  ┌─────────────────────────── 🌐 Transport Layer ─────────────────┐  ┃
┃  │                                                                  │  ┃
┃  │    ┌──────────────────┐              ┌──────────────────┐     │  ┃
┃  │    │   WebSocket      │              │   TCP Socket     │     │  ┃
┃  │    │   Transport      │              │   Transport      │     │  ┃
┃  │    │                  │              │                  │     │  ┃
┃  │    │ • Starscream     │              │ • 自定义协议      │     │  ┃
┃  │    │ • Ping/Pong      │              │ • 二进制头部      │     │  ┃
┃  │    │ • 自动重连       │              │ • CRC16 校验     │     │  ┃
┃  │    └──────────────────┘              └──────────────────┘     │  ┃
┃  │              │                                 │                │  ┃
┃  │              └─────────────┬─────────────────┘                │  ┃
┃  │                            │                                    │  ┃
┃  │                   ┌────────▼────────┐                          │  ┃
┃  │                   │  Transport      │                          │  ┃
┃  │                   │  Factory        │                          │  ┃
┃  │                   │  (工厂模式)      │                          │  ┃
┃  │                   └─────────────────┘                          │  ┃
┃  └──────────────────────────────────────────────────────────────┘  ┃
┃                                                                        ┃
┃  ┌─────────────────────────── 📦 Protocol Layer ──────────────────┐  ┃
┃  │                                                                  │  ┃
┃  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │  ┃
┃  │  │  Packet      │  │  Protocol    │  │   Message    │        │  ┃
┃  │  │  Codec       │  │  Codec       │  │   Encoder    │        │  ┃
┃  │  │              │  │              │  │              │        │  ┃
┃  │  │ • 粘包处理   │  │ • JSON       │  │ • 完整编码   │        │  ┃
┃  │  │ • 拆包处理   │  │ • Protobuf   │  │ • 序列号     │        │  ┃
┃  │  │ • CRC校验    │  │ • 序列化     │  │ • 时间戳     │        │  ┃
┃  │  └──────────────┘  └──────────────┘  └──────────────┘        │  ┃
┃  │                                                                  │  ┃
┃  │  ┌──────────────────────────────────────────────────────────┐ │  ┃
┃  │  │                   IMPacket 格式 (16 bytes + Body)        │ │  ┃
┃  │  │  ┌───────────────────────────────────────────────────┐  │ │  ┃
┃  │  │  │ magic | version | flags | command | seq | length  │  │ │  ┃
┃  │  │  │  2B   |   1B    |  1B   |   2B    | 4B  |   4B    │  │ │  ┃
┃  │  │  │              crc16  (2B)                           │  │ │  ┃
┃  │  │  └───────────────────────────────────────────────────┘  │ │  ┃
┃  │  └──────────────────────────────────────────────────────────┘ │  ┃
┃  └──────────────────────────────────────────────────────────────┘  ┃
┃                                                                        ┃
┃  ┌─────────────────────────── 💾 Database Layer ──────────────────┐  ┃
┃  │                                                                  │  ┃
┃  │        ┌────────────────────────────────────────────┐          │  ┃
┃  │        │        SQLite3 + WAL Mode                  │          │  ┃
┃  │        │                                             │          │  ┃
┃  │        │  ┌──────────┐  ┌──────────┐  ┌──────────┐│          │  ┃
┃  │        │  │ messages │  │conversations│ │  users  ││          │  ┃
┃  │        │  └──────────┘  └──────────┘  └──────────┘│          │  ┃
┃  │        │                                             │          │  ┃
┃  │        │  ┌──────────┐  ┌──────────┐  ┌──────────┐│          │  ┃
┃  │        │  │  groups  │  │  friends │  │sync_config│          │  ┃
┃  │        │  └──────────┘  └──────────┘  └──────────┘│          │  ┃
┃  │        └────────────────────────────────────────────┘          │  ┃
┃  │                                                                  │  ┃
┃  │  特性: WAL 并发读写 | 事务支持 | 批量优化 | OpenIM 完全冗余    │  ┃
┃  └──────────────────────────────────────────────────────────────┘  ┃
┃                                                                        ┃
┃  ┌─────────────────────────── 🌍 Network Layer ───────────────────┐  ┃
┃  │                                                                  │  ┃
┃  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │  ┃
┃  │  │    HTTP      │  │   Network    │  │    File      │        │  ┃
┃  │  │   Manager    │  │   Monitor    │  │   Transfer   │        │  ┃
┃  │  │              │  │              │  │              │        │  ┃
┃  │  │ • RESTful    │  │ • WiFi监听   │  │ • 断点续传   │        │  ┃
┃  │  │ • 重试机制   │  │ • 4G/5G监听  │  │ • 进度回调   │        │  ┃
┃  │  │ • 拦截器     │  │ • 自动重连   │  │ • 压缩处理   │        │  ┃
┃  │  └──────────────┘  └──────────────┘  └──────────────┘        │  ┃
┃  └──────────────────────────────────────────────────────────────┘  ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
                                     ⬇️ ⬆️
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃                         🛠️ Foundation Layer                          ┃
┃                                                                        ┃
┃  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              ┃
┃  │   📝 Logger  │  │   💾 Cache   │  │   🔐 Crypto  │              ┃
┃  │              │  │              │  │              │              ┃
┃  │ • 分级日志   │  │ • LRU缓存    │  │ • AES加密    │              ┃
┃  │ • 文件输出   │  │ • 内存管理   │  │ • RSA加密    │              ┃
┃  │ • 性能统计   │  │ • 过期策略   │  │ • MD5哈希    │              ┃
┃  └──────────────┘  └──────────────┘  └──────────────┘              ┃
┃                                                                        ┃
┃  ┌──────────────┐  ┌──────────────┐                                 ┃
┃  │   🔧 Utils   │  │  📊 Models   │                                 ┃
┃  │              │  │              │                                 ┃
┃  │ • UUID生成   │  │ • IMMessage  │                                 ┃
┃  │ • 时间戳     │  │ • IMUser     │                                 ┃
┃  │ • JSON解析   │  │ • IMGroup    │                                 ┃
┃  └──────────────┘  └──────────────┘                                 ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
```

---

## 🔄 数据流动图

### 消息发送流程

```
┌──────────────┐
│   用户点击   │
│   发送按钮   │
└──────┬───────┘
       │
       ▼
┌────────────────────────┐
│   IMClient             │
│   .messageManager      │
│   .sendMessage()       │
└────────┬───────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│   IMMessageManager                  │
│                                     │
│   1️⃣ 保存到数据库 (status: sending) │
│   2️⃣ 添加到消息队列                 │
│   3️⃣ 触发发送逻辑                   │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────┐
│   IMMessageQueue        │
│                         │
│   tryProcessQueue()     │
│   • 锁控制              │
│   • 串行发送            │
└────────┬────────────────┘
         │
         ▼
┌───────────────────────────────┐
│   IMTransport (TCP/WebSocket) │
│                               │
│   encode() → send()           │
└────────┬──────────────────────┘
         │
         ▼
    ═══════════
    🌐 Network
    ═══════════
         │
         ▼
┌────────────────────────┐
│   服务器               │
│                        │
│   处理消息 → 返回 ACK  │
└────────┬───────────────┘
         │
         ▼
    ═══════════
    🌐 Network
    ═══════════
         │
         ▼
┌───────────────────────────┐
│   IMTransport             │
│                           │
│   receive() → decode()    │
└────────┬──────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│   IMMessageManager                  │
│                                     │
│   1️⃣ 从队列移除                     │
│   2️⃣ 更新数据库 (status: sent)      │
│   3️⃣ 通知 UI                        │
└────────┬────────────────────────────┘
         │
         ▼
┌──────────────────────┐
│   UI 显示 ✅         │
│   消息已发送         │
└──────────────────────┘
```

### 消息接收流程

```
┌────────────────────────┐
│   服务器推送消息       │
└────────┬───────────────┘
         │
         ▼
    ═══════════
    🌐 Network
    ═══════════
         │
         ▼
┌───────────────────────────┐
│   IMTransport             │
│                           │
│   receive() → decode()    │
└────────┬──────────────────┘
         │
         ▼
┌─────────────────────────┐
│   IMMessageRouter       │
│                         │
│   route to handler      │
└────────┬────────────────┘
         │
         ▼
┌──────────────────────────────────────┐
│   IMClient                           │
│                                      │
│   handlePushMessage()                │
│   • 保存到数据库                     │
│   • 转发给 MessageManager            │
└────────┬─────────────────────────────┘
         │
         ▼
┌──────────────────────────────────────┐
│   IMMessageManager                   │
│                                      │
│   handleReceivedMessage()            │
│   1️⃣ 消息去重检查                    │
│   2️⃣ 更新会话 (lastMessage)          │
│   3️⃣ 增加未读数                      │
│   4️⃣ 通知监听器                      │
└────────┬─────────────────────────────┘
         │
         ▼
┌─────────────────────────┐
│   IMConversationManager │
│                         │
│   updateConversation()  │
│   incrementUnreadCount()│
└────────┬────────────────┘
         │
         ▼
┌──────────────────────┐
│   UI 收到通知        │
│   • 会话列表刷新     │
│   • 未读数更新       │
│   • 消息展示         │
└──────────────────────┘
```

### 增量同步流程

```
┌──────────────────────┐
│   网络恢复/重连成功  │
└────────┬─────────────┘
         │
         ▼
┌─────────────────────────┐
│   IMNetworkMonitor      │
│                         │
│   networkDidConnect()   │
└────────┬────────────────┘
         │
         ▼
┌───────────────────────────────────────┐
│   IMClient                            │
│                                       │
│   handleTransportConnected()          │
│   • 检测是重连                        │
│   • 获取本地最大 seq                  │
│   • 触发增量同步                      │
└────────┬──────────────────────────────┘
         │
         ▼
┌──────────────────────────────────────┐
│   IMMessageSyncManager               │
│                                      │
│   sync(fromSeq: localMaxSeq + 1)     │
└────────┬─────────────────────────────┘
         │
         ▼
┌──────────────────────────────────────┐
│   syncBatch()                        │
│                                      │
│   1️⃣ 请求服务器 (HTTP API)           │
│      GET /sync?fromSeq=xxx&limit=500 │
└────────┬─────────────────────────────┘
         │
         ▼
    ═══════════
    🌐 Network
    ═══════════
         │
         ▼
┌──────────────────────────────────────┐
│   服务器返回消息列表                 │
│                                      │
│   {                                  │
│     messages: [msg1, msg2, ...]      │
│     hasMore: true/false              │
│     nextSeq: xxx                     │
│   }                                  │
└────────┬─────────────────────────────┘
         │
         ▼
┌──────────────────────────────────────┐
│   IMMessageSyncManager               │
│                                      │
│   2️⃣ 保存到数据库（批量）            │
│   3️⃣ 更新 lastSyncSeq                │
│   4️⃣ 通知进度回调                    │
│   5️⃣ 如果 hasMore，继续下一批        │
└────────┬─────────────────────────────┘
         │
         ▼
┌──────────────────────┐
│   UI 收到通知        │
│   • 显示新消息       │
│   • 更新会话列表     │
└──────────────────────┘
```

---

## 🛡️ 可靠性保障体系

```
┌─────────────────────────────────────────────────────────────┐
│                     消息可靠性保障机制                      │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐      │
│  │   ACK 确认  │   │  超时重传   │   │  消息队列   │      │
│  │             │   │             │   │             │      │
│  │ • 服务器ACK │   │ • 5秒超时   │   │ • 持久化    │      │
│  │ • 序列号匹配│   │ • 最多3次   │   │ • 顺序发送  │      │
│  └─────────────┘   └─────────────┘   └─────────────┘      │
│                                                               │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐      │
│  │  序列号机制 │   │  CRC16校验  │   │  增量同步   │      │
│  │             │   │             │   │             │      │
│  │ • 检测丢包  │   │ • 数据完整性│   │ • 补齐消息  │      │
│  │ • 去重      │   │ • 快速失败  │   │ • 基于seq   │      │
│  └─────────────┘   └─────────────┘   └─────────────┘      │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                     连接可靠性保障机制                      │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐      │
│  │  心跳保活   │   │  自动重连   │   │  网络监听   │      │
│  │             │   │             │   │             │      │
│  │ • 30秒间隔  │   │ • 指数退避  │   │ • WiFi/4G   │      │
│  │ • Ping/Pong │   │ • 最大32秒  │   │ • 实时切换  │      │
│  └─────────────┘   └─────────────┘   └─────────────┘      │
│                                                               │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐      │
│  │  防抖机制   │   │  随机抖动   │   │  最大重试   │      │
│  │             │   │             │   │             │      │
│  │ • 10秒防抖  │   │ • ±30%抖动  │   │ • 5次上限   │      │
│  │ • 丢包检测  │   │ • 防雪崩    │   │ • 通知用户  │      │
│  └─────────────┘   └─────────────┘   └─────────────┘      │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                     数据可靠性保障机制                      │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐      │
│  │ SQLite+WAL  │   │  事务支持   │   │  消息去重   │      │
│  │             │   │             │   │             │      │
│  │ • 并发读写  │   │ • 原子性    │   │ • messageID │      │
│  │ • 崩溃恢复  │   │ • 一致性    │   │ • 主键约束  │      │
│  └─────────────┘   └─────────────┘   └─────────────┘      │
│                                                               │
│  ┌─────────────┐   ┌─────────────┐                          │
│  │  批量优化   │   │  完全冗余   │                          │
│  │             │   │             │                          │
│  │ • 批量写入  │   │ • OpenIM方案│                          │
│  │ • 性能提升  │   │ • N+1优化   │                          │
│  └─────────────┘   └─────────────┘                          │
└─────────────────────────────────────────────────────────────┘
```

---

## 📊 核心技术栈总览

```
┌──────────────────────────────────────────────────────────────┐
│                         开发语言                              │
│                                                                │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  Swift 5.9+                                            │  │
│  │  • 类型安全  • Protocol-Oriented  • Async/Await       │  │
│  └───────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│                         网络通信                              │
│                                                                │
│  ┌──────────────────────┐    ┌──────────────────────┐       │
│  │   WebSocket          │    │   TCP Socket         │       │
│  │                      │    │                      │       │
│  │ • Starscream 4.x     │    │ • 自研协议           │       │
│  │ • Ping/Pong 心跳     │    │ • 二进制头部         │       │
│  │ • 自动重连           │    │ • CRC16 校验         │       │
│  └──────────────────────┘    └──────────────────────┘       │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│                         数据存储                              │
│                                                                │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  SQLite3 + WAL                                         │  │
│  │  • C API 直接操作  • WAL 并发读写  • PRAGMA 优化      │  │
│  └───────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│                         序列化协议                            │
│                                                                │
│  ┌──────────────────────┐    ┌──────────────────────┐       │
│  │   JSON               │    │   Protobuf           │       │
│  │                      │    │                      │       │
│  │ • 易调试             │    │ • 高性能             │       │
│  │ • 兼容性好           │    │ • 体积小             │       │
│  └──────────────────────┘    └──────────────────────┘       │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│                         并发控制                              │
│                                                                │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  GCD + NSLock + NSRecursiveLock                        │  │
│  │  • 串行队列  • 锁保护  • 线程安全                      │  │
│  └───────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│                         设计模式                              │
│                                                                │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │
│  │  单例    │ │  工厂    │ │  策略    │ │  观察者  │       │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │
│                                                                │
│  ┌──────────┐ ┌──────────┐                                   │
│  │  POP     │ │  扩展    │                                   │
│  └──────────┘ └──────────┘                                   │
└──────────────────────────────────────────────────────────────┘
```

---

**文档版本**: 1.0.0  
**最后更新**: 2025-01-26

